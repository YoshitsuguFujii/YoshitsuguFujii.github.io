<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

    <title><![CDATA[なんとなく日々徒然と]]></title>
    <link href="http://yoshitsugufujii.github.io/atom.xml" rel="self"/>
    <link href="http://yoshitsugufujii.github.io/"/>
    <updated>2018-04-23T12:44:06+09:00</updated>
    <id>http://yoshitsugufujii.github.io/</id>
    <author>
        <name><![CDATA[Yoshitsugu Fujii]]></name>
        
    </author>
    <generator uri="http://octopress.org/">Octopress</generator>

    
    <entry>
        <title type="html"><![CDATA[潮干狩り 江戸川放水路]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/04/23/shiohigari/"/>
        <updated>2018-04-23T12:14:59+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/04/23/shiohigari</id>
        <content type="html"><![CDATA[<p>午前中は市川コルトンプラザの住宅展示場でプリキュアの握手会があったので大ファンの娘をつれて行ってきました。<br/>
そして午後からは<a href="http://www.sambanze.jp/facility/park/shell_gathering2018/">ふなばし 三番瀬海浜公園</a>の潮干狩り始まったようなので、<br/>
うちも潮干狩りするかってことで江戸川放水路に行きました。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>    <br/>
<ins class="adsbygoogle"    
     style="display:block; text-align:center;"    
     data-ad-layout="in-article"    
     data-ad-format="fluid"    
     data-ad-client="ca-pub-7039502723411845"    
     data-ad-slot="8206045005"></ins></p>

<script>      
     (adsbygoogle = window.adsbygoogle || []).push({});      
</script>


<p></p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20180423/IMG_4418.JPG" data-lightbox="edogawa" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20180423/IMG_4418.JPG"><br/>
</a></p>

<p>無料で潮干狩りができるとはいえ、江戸川の河口。<br/>
水質とか衛生的とはいえない部分もあるので完全自己責任の世界ですね。</p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20180423/IMG_4420.jpg" data-lightbox="edogawa" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20180423/IMG_4420.jpg"><br/>
</a></p>

<p>毎年妙典側ではマテ貝やアナジャコを取っている人がいますが市川よりはどうなんだろう。<br/>
あんまりやってる人いないような。</p>

<p>対岸の妙典は人いっぱいです。</p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20180423/IMG_4421.jpg" data-lightbox="edogawa" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20180423/IMG_4421.jpg"><br/>
</a></p>

<p><span style='text-align: center;'><br/>
  根掛かりしまくる牡蠣殼の塊。蹴っても動きません。<br/>
</span></p>

<p>1時間半ぐらい遊んでホンビノス4つです。<br/>
左のネットの中身はシオフキ・・・・</p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20180423/IMG_4422.jpg" data-lightbox="edogawa" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20180423/IMG_4422.jpg"><br/>
</a></p>

<p>砂抜きができれば意外とおいしいです。<br/>
うちはもっぱら佃煮にします。</p>

<p>急に気温があがったせいが泥がだいぶヘドロっつぽいにおいしてました。<br/>
次はお金出して三番瀬かな&hellip;</p>

<p>夕方になって市長選いってきました。</p>

<p>反自民ならなんでもいいというばかりに政策理論も違う社民、共産、自由など野党5党が支持した村越氏が当選されたようですね。<br/>
メディアの総力をあげての自民党、安倍叩きで票が流れたんですかね。</p>

<p>みずほたんも喜んでます。</p>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">千葉県市川市長選の再選挙は２２日、無所属新人で「５野党共闘」の元衆院議員村越ひろたみさんが当選！良かった。</p>&mdash; 福島みずほ (@mizuhofukushima) <a href="https://twitter.com/mizuhofukushima/status/988070898866548737?ref_src=twsrc%5Etfw">2018年4月22日</a></blockquote>


<p></p>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<p></p>

<p>うーん。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[高須海浜公園 サヨリ]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/04/18/takasu-sayori/"/>
        <updated>2018-04-18T11:12:33+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/04/18/takasu-sayori</id>
        <content type="html"><![CDATA[<p>釣行日 2018年04月15日(日)<br/>
天気 曇<br/>
場所 高須海浜公園<br/>
釣行時間: 16:00 〜 17:00</p>

<p>春の嵐ですが、午後から雨と風が和らぐというニュースを見て、急遽ちらほらと釣果情報が聞こえてくる春サヨリを釣りにいきます。<br/>
家族も引き連れてなので釣り場は高須海浜公園に決定。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>この時期のサヨリは産卵のために接岸しGWすぎぐらいまでは釣れるのだそう。</p>

<p>釣り場につくとチラホラといますね。</p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20180418/IMG_4347.jpg" data-lightbox="takasukaihinkouen" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20180418/IMG_4347.jpg"><br/>
</a></p>

<p>海をのぞくと春の嵐の影響で底荒れして濁り、海藻もたくさん浮いています。</p>

<p>早速一投。</p>

<p>海藻が釣れました (^^;</p>

<p>その後も海藻が何度かかかり一気に気力が萎えます。<br/>
他の方々も中々釣れてませんね。</p>

<p>もっぱら近くにすむというおじさんと30分ぐらい投げずに話してました。<br/>
おじさんはおととい40センチのサヨリをここであげたそう。</p>

<p>おじさんと話していると風がオンショアになり、オンショアだと釣れないからとおじさんは帰宅。</p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20180418/IMG_4349.jpg" data-lightbox="takasukaihinkouen" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20180418/IMG_4349.jpg"><br/>
</a></p>

<p>16:30ぐらいに隣の人がサヨリ釣り上げたのを見てあわてて投げます。<br/>
が釣れず。一回あたりはありましたがのらず。結果坊主。<br/>
隣の人は他にも２回ぐらい釣れてました。</p>

<p>おじさんに秋田狐で釣るといいよと教えてもらったので帰ってきてAMAZONでポチりました。<br/>
シーズンになると近くの釣具屋では品切れになってしまうのだそうな。</p>

<div class="kaerebalink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom: 1;overflow: hidden;"><div class="kaerebalink-image" style="float:left;margin:0 15px 10px 0;"><a href="https://www.amazon.co.jp/exec/obidos/ASIN/B015K82CUM/gogosakura-22/" target="_blank" ><img src="https://images-fe.ssl-images-amazon.com/images/I/4106I5rEZJL._SL160_.jpg" style="border: none;" /></a></div><div class="kaerebalink-info" style="line-height:120%;/zoom: 1;overflow: hidden;"><div class="kaerebalink-name" style="margin-bottom:10px;line-height:120%"><a href="https://www.amazon.co.jp/exec/obidos/ASIN/B015K82CUM/gogosakura-22/" target="_blank" >がまかつ(Gamakatsu) 糸付 秋田狐 フック 茶 6号-ハリス0.6 釣り針</a><div class="kaerebalink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="http://kaereba.com" rel="nofollow" target="_blank">カエレバ</a></div></div><div class="kaerebalink-detail" style="margin-bottom:5px;"> がまかつ(Gamakatsu)     </div><div class="kaerebalink-link1" style="margin-top:10px;"><div class="shoplinkamazon" style="display:inline;margin-right:5px"><a href="https://www.amazon.co.jp/gp/search?keywords=%E7%A7%8B%E7%94%B0%E7%8B%90%206%E5%8F%B7&__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&tag=gogosakura-22" target="_blank" >Amazon</a></div><div class="shoplinkrakuten" style="display:inline;margin-right:5px"><a href="https://hb.afl.rakuten.co.jp/hgc/16102ad8.0804351d.16102ad9.09702e1c/?pc=https%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2F%25E7%25A7%258B%25E7%2594%25B0%25E7%258B%2590%25206%25E5%258F%25B7%2F-%2Ff.1-p.1-s.1-sf.0-st.A-v.2%3Fx%3D0%26scid%3Daf_ich_link_urltxt%26m%3Dhttp%3A%2F%2Fm.rakuten.co.jp%2F" target="_blank" >楽天市場</a></div></div></div><div class="booklink-footer" style="clear: left"></div></div>


<p>来週はこれで再チャレンジするぞ!</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[中国ではGoogle reCAPTCHAを使えません]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/04/12/china-recaptcha/"/>
        <updated>2018-04-12T14:34:20+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/04/12/china-recaptcha</id>
        <content type="html"><![CDATA[<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>  
     (adsbygoogle = window.adsbygoogle || []).push({});  
</script>


<p></p>

<p>気をつけなはれや！</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[サーフィンを始める方に]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/04/11/surfin/"/>
        <updated>2018-04-11T12:42:29+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/04/11/surfin</id>
        <content type="html"><![CDATA[<p>先週の土日、連日九十九里の海岸でサーファーがなくなられたようで。<br/>
日曜日は海に入ってましたが、ほど近い場所で死亡事故が発生していたのはびっくりです。<br/>
流されたとしたら、暖かくなってきたとはいえ、今は水も冷たく想像を絶する恐怖だったと思います。<br/>
ご冥福をお祈りします。</p>

<p><a href="http://www3.nhk.or.jp/lnews/chiba/20180407/1080001978.html">東浪見</a><br/>
<a href="https://www.sankei.com/affairs/news/180408/afr1804080001-n1.html">本須賀</a></p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>  
     (adsbygoogle = window.adsbygoogle || []).push({});  
</script>


<p></p>

<p>私がサーフィンやった時は、転んでも下は水だから怪我しない。<br/>
海で遊んだり、プールで泳いだりするのは楽しいしサーフィンやりたい！という気持ちだけで始めました。</p>

<p>何回も流されそうになりながらやった経験としてはサーフィンはとても危険なスポーツだと思います。</p>

<p>子供ができたら子供にもやらせたいとか昔は考えてましたが、今は危なくってやらせたくないという気持ちに変わっています。</p>

<p>何が怖いかというと離岸流が一番怖いです。</p>

<p>流れるプールを逆に泳いだことがある人ならわかると思いますが、<br/>
それと同じか場合によってはそれよりも強い流れで沖にもって行かれます。</p>

<p>なので離岸流から抜けるためには真横にパドリングしなければいけないのですが<br/>
これが初心者には難しいです。</p>

<p>そもそもどこまで横にいけば離岸流から逃れられるのかわからないということ。<br/>
横にパドリングしても抜けれなければ体力だけを消耗してさらに流されるんじゃないかという恐怖。<br/>
横ってどっち？右？左？(カレントによっては右か左に流れたあと沖に流れるカレントになっていることがあるため)<br/>
このくらいなら流れに逆らってパドルすれば岸に到着できるんじゃないかと思いやってみたら体力だけ消耗して進んでいない。</p>

<p>体力がなくなってくると余裕もなくなります。<br/>
焦りが高まり、戻れないのではという絶望感に変わります。<br/>
そうなるとパニックになり呼吸も浅くなって辛くなり、死がどんどん近づいてくるような気がします。</p>

<p>こんなことが岸から25メートル以内でおこったりします。</p>

<p>そしてそんな状況でも他のサーファーは助けれません。<br/>
誰かにパドリングしてもらうことはできません。<br/>
自力でパドリングして帰るしかないのです。</p>

<p>この恐怖を知ってしまってやめてしまうサーフィン初心者も多いようです。</p>

<p>無事に帰れればいいですが、取り返しのつかないことにならないように<br/>
初心者の方は以下に気をつけましょう。</p>

<ul>
<li>初心者は経験者と行く。</li>
<li>はじめは他のサーファーのいない足のつくところで練習する</li>
<li>波のサイズが大きい時は入らない</li>
</ul>


<p>と書きましたが私自身、サーフィンはくっそ下手です。</p>

<p>今年はサーフィンと釣り、頑張ろう。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[サーフィン 一宮]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/04/09/surfin/"/>
        <updated>2018-04-09T16:09:15+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/04/09/surfin</id>
        <content type="html"><![CDATA[<p>稲毛の上州屋に行ったらファミリーが多くて賑わってました。<br/>
暖かくなってきたのでみなさん釣りをやられるようです。<br/>
セット物の竿とかみています。</p>

<p>店員さんに「ポートタワーで何が今釣れますか？何買えばいいですか？」<br/>
って聞いているお父さんがいたので思わず聞き耳たててしまいました。</p>

<p>今は「フッコかセイゴ狙いになりますね。」</p>

<p>ですよねー。<br/>
と心の中でつぶやきます。<br/>
サビキでしか釣果をあげられない自分としてはサビキをたらせる日々が待ち遠しいです。</p>

<p>先週8ヶ月ぶりぐらいにサーフィンしたらヨボヨボのじいさん並みに体力落ちていたので、<br/>
昨日も一宮でサーフィンをしてきました。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>  
     (adsbygoogle = window.adsbygoogle || []).push({});  
</script>


<p></p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20180409/IMG_4279.JPG" data-lightbox="surfin" data-title=""/>  <br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20180409/IMG_4279.JPG">  <br/>
</a></p>

<p>14時ぐらいから波なくなる。</p>

<p>今年は落とし込みにも挑戦したいと思っているところ。<br/>
そういえば以前テトラにびっしりとカニがいたことあったなと調査。</p>

<p>カニは丹念に探して1匹2匹。<br/>
もうちょい後なのかな？</p>

<p>イガイはいっぱいありました。<br/>
ウェットきていることをいいことにジャブジャブはいって削ってみました。</p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20180409/IMG_4283.JPG" data-lightbox="surfin" data-title=""/>  <br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20180409/IMG_4283.JPG">  <br/>
</a></p>

<p>そんあことやってたら足の親指をすっぱり切ってました。</p>

<p>気をつけましょう。</p>

<p>帰りに太東港みてみましたが昼間だからもあったのか渋そうでした。<br/>
小さい3〜5センチぐらいのイワシか何かが泳いでました。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[Heroku小ネタ]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/04/03/rack-attack/"/>
        <updated>2018-04-03T11:43:22+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/04/03/rack-attack</id>
        <content type="html"><![CDATA[<p>HerokuでRailsアプリ動かすときは<br/>
<a href="https://github.com/kickstarter/rack-attack">rack-attack</a><br/>
入れといたほうが良さそう。</p>

<p><a href="https://help.heroku.com/HCCDCDYY/does-heroku-offer-ddos-denial-of-service-mitigation">https://help.heroku.com/HCCDCDYY/does-heroku-offer-ddos-denial-of-service-mitigation</a></p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>ちなみにthrottleの機能を使ってみたんですが、cacheを使って試行回数を判定するのでcache storeをnull_storeとかにしちゃうといつまでもローカルではテストできません。</p>

<p>最近釣りに行き始めてますが連続坊主中。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[最後にサインアウトした時間が欲しい]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/03/12/current-sign-out-at/"/>
        <updated>2018-03-12T12:51:13+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/03/12/current-sign-out-at</id>
        <content type="html"><![CDATA[<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>before_logoutというwardenのフックメソッドがあるのでそこに追加<br/>
自分はconfig/initializers/devise.rbに追加しちゃいました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Warden</span><span class="o">::</span><span class="no">Manager</span><span class="o">.</span><span class="n">before_logout</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="p">,</span><span class="n">auth</span><span class="p">,</span><span class="n">opts</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">User</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">update_column</span><span class="p">(</span><span class="ss">:current_sign_out_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">current</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[Railsでredirect_toが呼ばれたか判定]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/03/05/rails-redirect-called/"/>
        <updated>2018-03-05T11:34:15+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/03/05/rails-redirect-called</id>
        <content type="html"><![CDATA[<p>アクションメソッドから呼び出したメソッドで呼ばれているかどうか</p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p><a href="http://www.rubydoc.info/gems/rack/Rack/Response/Helpers#redirect%2F-instance_method">#redirect?</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">response</span><span class="o">.</span><span class="n">redirect?</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[GrapeでCSRF対策]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/02/26/csrf-with-grape/"/>
        <updated>2018-02-26T17:38:51+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/02/26/csrf-with-grape</id>
        <content type="html"><![CDATA[<p>セキュリティ試験を受けたらapiでpostしている箇所がcsrf違反でレポートが上がってきました。<br/>
apiでcsrfって必要なの？<br/>
って感じでしたが実際にレポートあがってきてしまっているしよくよく考えたら必要じゃんってなったので実装します。</p>

<p>ググってみると情報が少ないですね。<br/>
みなさんgrapeでcsrfどうしているんでしょう。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>gistでサンプル見つけましたが、<br/>
<a href="https://gist.github.com/jandudulski/f3799ca67b7b08ded0c6">jandudulski/auth.rb</a><br/>
Rails5.1.4では動きません。</p>

<p><a href="https://github.com/rails/rails/blob/master/actionpack/lib/action_controller/metal/request_forgery_protection.rb">actionpackのcsrfの実装</a><br/>
をみながら実装してみます。</p>

<p>結果としてはこんな感じになりました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">V1</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">RequestForgeryProtectionHelper</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">session</span>
</span><span class='line'>      <span class="n">env</span><span class="o">[</span><span class="s1">&#39;rack.session&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">protect_against_forgery</span>
</span><span class='line'>      <span class="k">unless</span> <span class="n">verified_request?</span>
</span><span class='line'>        <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;[API] Can&#39;t verify CSRF token authenticity.&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">error!</span><span class="p">(</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="ss">result</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span>
</span><span class='line'>            <span class="ss">status</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;csrf_error&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="ss">message</span><span class="p">:</span> <span class="s2">&quot;Can&#39;t verify CSRF token authenticity.&quot;</span>
</span><span class='line'>          <span class="p">},</span> <span class="mi">401</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">verified_request?</span>
</span><span class='line'>      <span class="o">!</span><span class="n">protect_against_forgery?</span> <span class="o">||</span> <span class="n">request</span><span class="o">.</span><span class="n">get?</span> <span class="o">||</span> <span class="n">request</span><span class="o">.</span><span class="n">head?</span> <span class="o">||</span>
</span><span class='line'>        <span class="n">authenticity_token_valid?</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">authenticity_token_valid?</span>
</span><span class='line'>      <span class="n">encoded_masked_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;X-CSRF-Token&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;X-Csrf-Token&#39;</span><span class="o">]</span>
</span><span class='line'>      <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">encoded_masked_token</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>      <span class="n">masked_token</span> <span class="o">=</span> <span class="no">Base64</span><span class="o">.</span><span class="n">strict_decode64</span><span class="p">(</span><span class="n">encoded_masked_token</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">anonymous_controller</span> <span class="o">=</span> <span class="no">ApplicationController</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">masked_token</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">RequestForgeryProtection</span><span class="o">::</span><span class="no">AUTHENTICITY_TOKEN_LENGTH</span>
</span><span class='line'>        <span class="n">anonymous_controller</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:compare_with_real_token</span><span class="p">,</span> <span class="n">masked_token</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">masked_token</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">RequestForgeryProtection</span><span class="o">::</span><span class="no">AUTHENTICITY_TOKEN_LENGTH</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'>        <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">anonymous_controller</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:unmask_token</span><span class="p">,</span> <span class="n">masked_token</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">anonymous_controller</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:compare_with_real_token</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="kp">false</span> <span class="c1"># Token is malformed.</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">protect_against_forgery?</span>
</span><span class='line'>      <span class="n">allow_forgery_protection</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">action_controller</span><span class="o">.</span><span class="n">allow_forgery_protection</span>
</span><span class='line'>      <span class="n">allow_forgery_protection</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">allow_forgery_protection</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">V1</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Root</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
</span><span class='line'>    <span class="n">helpers</span> <span class="no">RequestForgeryProtectionHelper</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">protect_against_forgery</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>クライアント側</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span> <span class="s1">&#39;meta[name=&quot;csrf-token&quot;]&#39;</span> <span class="p">).</span><span class="nx">attr</span><span class="p">(</span> <span class="s1">&#39;content&#39;</span> <span class="p">);</span>
</span><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">xhr</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span> <span class="s1">&#39;X-CSRF-Token&#39;</span><span class="p">,</span> <span class="nx">token</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[Doorkeeperの認証で使われるtokenを取得]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/02/15/get-doorkeeper-token/"/>
        <updated>2018-02-15T11:46:00+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/02/15/get-doorkeeper-token</id>
        <content type="html"><![CDATA[<p>doorkeeprの処理のなかで削除済のユーザのステータスが取りたくて、tokenを取得できるかやってみました。</p>

<p>イレギュラーアクセス -> tokenが取れない。<br/>
通常のアクセス -> tokenが取れる。ユーザがひける。<br/>
削除済または退会済みユーザへのアクセス -> tokenが取れる。ユーザがひけない。</p>

<p>って感じでしょうか？</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>下記のようにしたら取れました。<br/>
あとはこれをうまくつかってerrorとかで削除済のレスポンスを返す感じですね。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># frozen_string_literal: true</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;doorkeeper/grape/helpers&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">V1</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Root</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
</span><span class='line'>    <span class="n">helpers</span> <span class="no">Doorkeeper</span><span class="o">::</span><span class="no">Grape</span><span class="o">::</span><span class="no">Helpers</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">authorization_request</span> <span class="o">=</span> <span class="no">Doorkeeper</span><span class="o">::</span><span class="no">Grape</span><span class="o">::</span><span class="no">AuthorizationDecorator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># これでrequestからtokenが取れる</span>
</span><span class='line'>      <span class="n">token</span> <span class="o">=</span> <span class="no">Doorkeeper</span><span class="o">::</span><span class="no">OAuth</span><span class="o">::</span><span class="no">Token</span><span class="o">.</span><span class="n">from_request</span><span class="p">(</span><span class="n">authorization_request</span><span class="p">,</span> <span class="o">*</span><span class="no">Doorkeeper</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">access_token_methods</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># そのトークンを使ってユーザのトークンが取れる。</span>
</span><span class='line'>      <span class="n">access_token</span> <span class="o">=</span> <span class="no">Doorkeeper</span><span class="o">::</span><span class="no">AccessToken</span><span class="o">.</span><span class="n">by_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">doorkeeper_authorize!</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mount</span> <span class="no">Users</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[S3に直接にファイルアップロード]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/02/14/direct-upload-to-s3-with-rails-and-carrierwave/"/>
        <updated>2018-02-14T18:35:13+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/02/14/direct-upload-to-s3-with-rails-and-carrierwave</id>
        <content type="html"><![CDATA[<p>Herokuでの大きいファイルアップロードはリクエストタイムアウトが30秒に設定されているのでやっかいです。</p>

<p>Herokuの公式でも4MBを超えるファイルをあげる場合はS3に直接あげてねって書いてあります。<br/>
<a href="https://devcenter.heroku.com/articles/s3#direct-upload">https://devcenter.heroku.com/articles/s3#direct-upload</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>This is the preferred approach if you’re working with file uploads bigger than 4MB. The idea is to skip the hop to your dyno, making a direct connection from the end user browser to S3. While this reduces the processing required by your application it is a more complex implementation and limits the ability to modify (transform, filter, resize etc…) the file before storing in S3.</span></code></pre></td></tr></table></div></figure>


<p>carriwaveを使っているのでcarriwave_directいいなと思いましたが、<br/>
<a href="https://github.com/dwilkie/carrierwave_direct">carrierwave_direct</a></p>

<p>最終更新日が結構前でメンテされていないのかな？ってのとgemを使いすぎるとわけわかめになるので自力でやることにしました。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>署名付きアップロード用のリンクを生成してjsに渡しjsでそのurlにアップロードする流れです。</p>

<p>Awsコンソールにログインしてs3からBucketを作成します。<br/>
作成したBucketを選択してアクセス権限タブからCORSの設定を開きます。<br/>
以下のように設定します。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
</span><span class='line'>&lt;CORSConfiguration xmlns="http://s3.amazonaws.com/doc/2006-03-01/"&gt;
</span><span class='line'>&lt;CORSRule&gt;
</span><span class='line'>    &lt;AllowedOrigin&gt;*&lt;/AllowedOrigin&gt;
</span><span class='line'>    &lt;AllowedMethod&gt;GET&lt;/AllowedMethod&gt;
</span><span class='line'>    &lt;AllowedMethod&gt;PUT&lt;/AllowedMethod&gt;
</span><span class='line'>    &lt;MaxAgeSeconds&gt;3000&lt;/MaxAgeSeconds&gt;
</span><span class='line'>    &lt;AllowedHeader&gt;*&lt;/AllowedHeader&gt;
</span><span class='line'>&lt;/CORSRule&gt;
</span><span class='line'>&lt;/CORSConfiguration&gt;</span></code></pre></td></tr></table></div></figure>


<p>次にGemfileに追記してbundle install</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Gemfile</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;aws-sdk&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>S3_BUCKETを操作できるようにします。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config/initializers/aws.rb</span>
</span><span class='line'><span class="n">credentials</span> <span class="o">=</span> <span class="no">Aws</span><span class="o">::</span><span class="no">Credentials</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>  <span class="no">ENV</span><span class="o">[</span><span class="ss">:aws_access_key</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="no">ENV</span><span class="o">[</span><span class="ss">:aws_secret</span><span class="o">]</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">s3_resource</span> <span class="o">=</span> <span class="no">Aws</span><span class="o">::</span><span class="no">S3</span><span class="o">::</span><span class="no">Resource</span><span class="o">::</span><span class="kp">new</span><span class="p">(</span><span class="ss">region</span><span class="p">:</span> <span class="s1">&#39;bucketのregion&#39;</span><span class="p">,</span> <span class="ss">credentials</span><span class="p">:</span> <span class="n">credentials</span><span class="p">)</span>
</span><span class='line'><span class="no">S3_BUCKET</span> <span class="o">=</span> <span class="n">s3_resource</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="s1">&#39;bucket名&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>URL生成のメソッドはCarrierwaveのuploaderクラスにメソッド生やしました。<br/>
取得はそのままCarrierwaveを使うイメージです。<br/>
今のプロジェクトでは基底クラスを作ってそれを継承させてます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">store_dir</span>
</span><span class='line'>    <span class="s2">&quot;uploads/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">presigned_url</span><span class="p">(</span><span class="n">file_name</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="n">file_name</span> <span class="o">||=</span> <span class="nb">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">attributes</span><span class="o">[</span><span class="n">mounted_as</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span>
</span><span class='line'>    <span class="n">object</span> <span class="o">=</span> <span class="no">S3_BUCKET</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="o">[</span><span class="n">store_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="n">object</span><span class="o">.</span><span class="n">presigned_url</span><span class="p">(</span><span class="ss">:put</span><span class="p">,</span> <span class="ss">expires_in</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">minutes</span><span class="o">.</span><span class="n">to_i</span><span class="p">,</span> <span class="ss">acl</span><span class="p">:</span> <span class="s1">&#39;private&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">ApplicationUploader</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>これで以下のように署名付きリンクを生成できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">presigned_url</span> <span class="c1"># =&gt; 署名付きのs3直アップロードurl</span>
</span></code></pre></td></tr></table></div></figure>


<p>署名付きリンクはデフォルトで900秒（15分）で失効します(上記uploaderでは1分にしている)<br/>
そのためcontrollerに生成してhiddenとかgonで渡すのはやめたほうがいい気がします。</p>

<p>jsで署名付きリンク生成リクエストをもらってurlを返し、そのurlでs3にアップロードするようにします。</p>

<p>Grapeでapiを作ります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">params</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">requires</span> <span class="ss">:file_name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">desc</span><span class="p">:</span> <span class="s1">&#39;ファイル名&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">post</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span>
</span><span class='line'>  <span class="n">user</span><span class="o">.</span><span class="n">update_column</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:file_name</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">filename</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:file_name</span><span class="o">]</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">presigned_url</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>carriwaveで処理させたいのですがstore先にidが必要なため保存しています。</p>

<p>以下リンク取得からアップロードまでのサンプルです。<br/>
ちょっと適当な部分があるので動かなかったらすいません。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">();</span>
</span><span class='line'><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.file&#39;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;grapeのurl&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">data</span> <span class="o">:</span> <span class="p">{</span><span class="nx">file_name</span><span class="o">:</span> <span class="nx">fileData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">).</span><span class="nx">name</span><span class="p">},</span>
</span><span class='line'>  <span class="nx">type</span> <span class="o">:</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">dataType</span> <span class="o">:</span> <span class="s1">&#39;json&#39;</span>
</span><span class='line'><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">url</span> <span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">data</span> <span class="o">:</span> <span class="nx">fileData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">type</span> <span class="o">:</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">dataType</span> <span class="o">:</span> <span class="s1">&#39;xml&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">processData</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">contentType</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">success</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;成功したよー&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">error</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;失敗。無念&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>carrierwave-attachmentscannerを使っていたんですが、これは直アップロードだと使えないので、保存と同時にafter_saveでsidekiqのキューに押し込んであとでウィルスチェックしています。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[carrierwaveのリンクの有効期間を個別に設定]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/02/09/carrierwave-expire-setting/"/>
        <updated>2018-02-09T19:27:03+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/02/09/carrierwave-expire-setting</id>
        <content type="html"><![CDATA[<p>全体でかける場合はこうですかね。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config/initializers/carrierwave.rb</span>
</span><span class='line'><span class="no">CarrierWave</span><span class="o">::</span><span class="no">SanitizedFile</span><span class="o">.</span><span class="n">sanitize_regexp</span> <span class="o">=</span> <span class="sr">/[^[:word:]\.\-\+]/</span> <span class="c1"># for Japanese</span>
</span><span class='line'><span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_credentials</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">provider</span><span class="p">:</span>              <span class="s1">&#39;AWS&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">aws_access_key_id</span><span class="p">:</span>     <span class="no">ENV</span><span class="o">[</span><span class="ss">:access_key</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">aws_secret_access_key</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="ss">:secret</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">region</span><span class="p">:</span>                <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;s3_region&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_public</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_directory</span> <span class="o">=</span> <span class="no">Settings</span><span class="o">.</span><span class="n">aws</span><span class="o">[</span><span class="s1">&#39;s3_bucket&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">cache_storage</span> <span class="o">=</span> <span class="ss">:fog</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_authenticated_url_expiration</span> <span class="o">=</span> <span class="mi">1</span><span class="o">.</span><span class="n">minutes</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>個々のアップローダークラスでかける場合</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">fog_authenticated_url_expiration</span>
</span><span class='line'>    <span class="mi">1</span><span class="o">.</span><span class="n">minutes</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>
uploader内ではmodelでモデル側のインスタンスを参照できるのでmodel側の条件で動的に有効期限を変えるとかもできそうですね。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[ruby2.5にあげたら例外発生時にstacktraceが吐き出されなくなった]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/01/31/no-backtrace/"/>
        <updated>2018-01-31T11:51:51+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/01/31/no-backtrace</id>
        <content type="html"><![CDATA[<p>Railsである日を境に例外発生時にスタックトレースがでなくなっちゃいました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>F, [2018-01-31T11:41:40.388898 #5662] FATAL -- : 
</span><span class='line'>NoMethodError - undefined method `company_users' for nil:NilClass:</span></code></pre></td></tr></table></div></figure>


<p>railsのlogにはこれしかでない。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>検索すると発見。</p>

<p><a href="https://stackoverflow.com/questions/48327987/why-does-ruby-2-5-0-not-show-a-stacktrace-in-rails-5-1-4">Why does Ruby 2.5.0 not show a stacktrace in Rails 5.1.4?</a></p>

<p>なるほどrubyを2.5にあげたからか。</p>

<p>手元の環境を見ると</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ruby (2.5)  
</span><span class='line'>rails (5.1.4)  
</span><span class='line'>binding_of_caller (0.7.2)</span></code></pre></td></tr></table></div></figure>


<p>0.8.0にbinding_of_callerにあげて解決です。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[国際化対応(お金関連)]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/01/30/money-localization/"/>
        <updated>2018-01-30T10:27:12+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/01/30/money-localization</id>
        <content type="html"><![CDATA[<p>国際化対応。<br/>
DBの日時はutcで保存して表示する時にユーザによって該当のタイムゾーンで表示とか色々な知見はあるかと思いますが。<br/>
お金の区切りもあるんですね。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>お金ってカンマ区切りだけかと思い込んでましたがそうじゃないらしいです。</p>

<p><a href="http://coliss.com/articles/build-websites/operation/writing/53.html">世界各国での数字の区切り方</a></p>

<p>数値がペリオドで送られてくる国やスペースで送ってくる国があるので注意が必要です。<br/>
カンマ一括で消して処理していたらバリデーションで特定の国入力エラーになっていた。</p>

<p>jsのtoLocaleStringとか使うとドイツのブラウザではカンマではなくペリオド入るらしいので気をつけるべし</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[Doorkeeperでパスワードが変更されたらクライアント側でログアウトさせる]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/01/29/logout-when-doorkeeper-password-change/"/>
        <updated>2018-01-29T14:26:19+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/01/29/logout-when-doorkeeper-password-change</id>
        <content type="html"><![CDATA[<p><a href="https://github.com/doorkeeper-gem/doorkeeper">Doorkeeper</a>を使ったoauthの仕組みでプラットフォーム側でパスワード変更の処理を書いててパスワード変更しても現在ログイン状態のユーザーがログアウトされなくて久しぶりにどっぷりハマったのでメモ。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>セッションストアであるredisを見ると同じユーザーで二つのブラウザでログインすると２つ違うsession keyで保持されている。<br/>
このセッションの中身は</p>

<p>一つ目はwarden key(そのままだとユーザID)<br/>
二つ目はencrypted_password</p>

<p>となっているようだ。</p>

<p><a href="https://stackoverflow.com/a/23683925/2223472">https://stackoverflow.com/a/23683925/2223472</a></p>

<p>Doorkeeperを使っているクライアントではoauth認証を使うのでパスワードを使っていない<br/>
そのため二つめencrypted_passwordの値は空になっている。</p>

<p>この二つの値を使って認証しているようだ。</p>

<p>プラットフォーム側でパスワードを変更しても二つ目の値は相変わらず空のためクライアント側ではセッションの状況に変化なしとなり<br/>
そのままログインが保持されてしまう。</p>

<p>tokenを使ったりパスワードを渡す等があったりしたがこうした。</p>

<p>まず、 パスワード変更時刻をプラットフォーム側にcolumnとして追加。<br/>
パスワード変更時にupdateするようにする。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User &lt; ApplicationRecord  
</span><span class='line'>  def reset_password(*args)  
</span><span class='line'>    self.password_changed_at = Time.current  
</span><span class='line'>    super  
</span><span class='line'>  end  
</span><span class='line'>end  </span></code></pre></td></tr></table></div></figure>


<p></p>

<p>そしてクライアントサイドでは連携されたpassword_changed_atを使うようにする。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User &lt; ApplicationRecord  
</span><span class='line'>  def authenticatable_salt  
</span><span class='line'>    password_changed_at  
</span><span class='line'>  end  
</span><span class='line'>end  </span></code></pre></td></tr></table></div></figure>


<p></p>

<p>これでパスワードが変更されるとクライアントのセッションの中身も変わり、<br/>
他のブラウザでログインしていても適切にログアウトされる。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[CircleCIでRuby2.5使おうとしたらbad interpreter]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/01/26/circle-ci-ver-one-ruby-two-five-bad-interpreter/"/>
        <updated>2018-01-26T18:51:07+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/01/26/circle-ci-ver-one-ruby-two-five-bad-interpreter</id>
        <content type="html"><![CDATA[<p>一度は成功していたのに急にCircleCI 1.0がこけるようになってしまいました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>set ruby version to 2.5.0  </span></code></pre></td></tr></table></div></figure>


<p></p>

<p>で</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ruby-2.5.0 - #generating default wrappers|/-\|/-\|.-\|/-\|/-.|/-\|/-\|.-\|/-\|/-.|/-\|/-\|.-\|/-\|/-.|/-\|/-\|.-\|/-\|.  
</span><span class='line'>Using /home/ubuntu/.rvm/gems/ruby-2.5.0  
</span><span class='line'>/home/ubuntu/.rvm/scripts/override_gem: /home/ubuntu/.rvm/rubies/ruby-2.5.0/bin/gem: /home/travis/.rvm/rubies/ruby-2.5.0/bin/ruby: bad interpreter: No such file or directory  </span></code></pre></td></tr></table></div></figure>


<p></p>

<p>のようなエラー。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>調べるとこんなツイートが&hellip;</p>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="en" dir="ltr"><a href="https://twitter.com/circleci?ref_src=twsrc%5Etfw">@circleci</a> I&#39;m getting build failures on ruby 2.5 - it looks like the `gem` command is using a shebang that references a non-existent `/home/travis` directory <a href="https://t.co/UcZREdK2Q8">pic.twitter.com/UcZREdK2Q8</a></p>&mdash; Justin Rhinesmith (@jerhinesmith) <a href="https://twitter.com/jerhinesmith/status/956311677426741248?ref_src=twsrc%5Etfw">2018年1月24日</a></blockquote>


<p></p>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<p></p>

<p>sshするとshebangでエラーになっている同じ現象でした。<br/>
そしてこんなチケットが&hellip;</p>

<p><a href="https://discuss.circleci.com/t/ruby-2-5-0-builds-failing-on-circleci-1-0-due-to-missing-home-travis/19620">Ruby 2.5.0 builds failing on CircleCI 1.0 due to missing <code>/home/travis</code></a></p>

<p>解決しているらしいのですが、普通にエラーでますがな&hellip;<br/>
マニュアルで</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>machine:  
</span><span class='line'>  pre:  
</span><span class='line'>    - sudo ln -s /opt/circleci /home/travis  </span></code></pre></td></tr></table></div></figure>


<p></p>

<p>を仕込もうとしたらもうありますエラー。<br/>
そして微妙にパスも違う。</p>

<p>結論。こうしてなおしました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>machine:  
</span><span class='line'>  pre:  
</span><span class='line'>    - sudo rm -rf /home/travis  
</span><span class='line'>    - sudo ln -s /home/ubuntu /home/travis  
</span><span class='line'>  ruby:  
</span><span class='line'>    version: 2.5.0  </span></code></pre></td></tr></table></div></figure>


<p></p>

<p>すぐなおってくれると思いますが、お困りの人がいたら上記で治ります。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[ridgepoleの部分インデックスで毎回createとdrop indexをさせない書き方]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/01/22/ridgepole-partial-uniq-index/"/>
        <updated>2018-01-22T14:44:35+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/01/22/ridgepole-partial-uniq-index</id>
        <content type="html"><![CDATA[<p>railsでparanoiaとか使っていて、<br/>
mysqlで論理削除にdeleted_atがnullかどうかで論理削除判定していると<br/>
dbのuniq indexで辛い感じになります。</p>

<p>postgresqlでは部分インデックスなるものがあり、deleted_atがnullのものをuniq制約の条件に含めないとかいうことができます。</p>

<p><a href="https://www.postgresql.jp/document/9.2/html/indexes-partial.html">部分インデックス</a></p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>ridgepoleではこう書くと毎回create index drop indexしません。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>add_index "users", ["email"], name: "uniq_email_idx", unique: true, where: '(deleted_at IS NULL)'  </span></code></pre></td></tr></table></div></figure>


<p></p>

<p>本日は大雪らしいので早く帰りましょう。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[テーブルで手軽に炙りを体験]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2017/12/26/soto-toach/"/>
        <updated>2017-12-26T10:15:14+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2017/12/26/soto-toach</id>
        <content type="html"><![CDATA[<p>みなさんはま寿司とか行きますか？<br/>
回る寿司屋ではあぶり系のネタが一番充実しているような気がします。</p>

<p>あぶりしめ鯖おいしいですね。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>我が家であぶりたい時にはこれを使っています。</p>

<table  border="0" cellpadding="5" style="border:none"><tr><td valign="top" style="border:none"><a href="https://hb.afl.rakuten.co.jp/hgc/g00r3jp6.4dryw726.g00r3jp6.4dryxab7/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fhimaraya%2F0000000322484%2F&m=http%3A%2F%2Fm.rakuten.co.jp%2Fhimaraya%2Fi%2F10087427%2F" target="_blank" ><img src="https://thumbnail.image.rakuten.co.jp/@0_mall/himaraya/cabinet/tentou3bai_1/0000000322484_r1_01.jpg?_ex=128x128" border="0" style="margin-right:10px" /></a></td><td valign="top" style="border:none;text-align:left"><div class="kaerebalink-name" style="margin-bottom:10px;line-height:120%"><a href="https://hb.afl.rakuten.co.jp/hgc/g00r3jp6.4dryw726.g00r3jp6.4dryxab7/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fhimaraya%2F0000000322484%2F&m=http%3A%2F%2Fm.rakuten.co.jp%2Fhimaraya%2Fi%2F10087427%2F" target="_blank" >ソト SOTO トーチ　チャッカ— ポケットサイズ バーナー ST-480</a></div><div class="kaerebalink-detail" style="margin-bottom:5px;"></div><table style="border:none;margin-top:10px"><tr><td style="border:none;text-align:left;"><div class="shoplinkrakuten" style="margin-right:5px"><a href="https://hb.afl.rakuten.co.jp/hgc/16102ad8.0804351d.16102ad9.09702e1c/?pc=http%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2FSOTO%2520%25E3%2583%259D%25E3%2582%25B1%25E3%2583%2583%25E3%2583%2588%25E3%2583%2588%25E3%2583%25BC%25E3%2583%2581%2F-%2Ff.1-p.1-s.1-sf.0-st.A-v.2%3Fx%3D0%26scid%3Daf_ich_link_urltxt%26m%3Dhttp%3A%2F%2Fm.rakuten.co.jp%2F" target="_blank" >楽天市場</a></div><div class="shoplinkamazon" style="margin-right:5px"><a href="http://www.amazon.co.jp/gp/search?keywords=SOTO%20%E3%83%9D%E3%82%B1%E3%83%83%E3%83%88%E3%83%88%E3%83%BC%E3%83%81&__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&tag=gogosakura-22" target="_blank" >Amazon</a></div></td><td style="vertical-align:bottom;padding-left:10px;font-size:x-small;border:none">by <a href="http://kaereba.com" rel="nofollow" target="_blank">カエレバ</a></td></tr></table></font></td></tr></table>


<p></p>

<p>火力もそこそこで携帯性が良くて取り回しがいいです。<br/>
食卓においても邪魔にならない。</p>

<p>炙りしめ鯖<br/>
<a href="http://yoshitsugufujii.github.io/images/blog/20171226/IMG_3432.jpg" data-lightbox="aburi" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20171226/IMG_3432.jpg"><br/>
</a></p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20171226/IMG_3433.jpg" data-lightbox="aburi" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20171226/IMG_3433.jpg"><br/>
</a></p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20171226/IMG_3434.jpg" data-lightbox="aburi" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20171226/IMG_3434.jpg"><br/>
</a></p>

<p>炙りサーモンチーズ<br/>
<a href="http://yoshitsugufujii.github.io/images/blog/20171226/IMG_3437.jpg" data-lightbox="aburi" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20171226/IMG_3437.jpg"><br/>
</a></p>

<p>わさびの袋とかとっちらかっててすいません。<br/>
ほんと便利でテーブルで必要な時に必要な時にだけ炙れますし、<br/>
炙りたての暖かいうちに食べれます。</p>

<p>スルメとか炙ってもいいかもしれません。</p>

<p>本格的なガスバーナーに比べて火力がないのでお子様でも扱えると思います。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[HerokuのNewRelicでRoleがUserで何もできない]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2017/12/21/heroku-at-herokumanager-dot-com/"/>
        <updated>2017-12-21T13:55:13+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2017/12/21/heroku-at-herokumanager-dot-com</id>
        <content type="html"><![CDATA[<p>子供が生まれましたのでしばらく釣りはお休みです。<br/>
春ぐらいになったら行きたいなぁ。</p>

<p>妻が帝王切開で産んだので、12月は週１の無理のない時間での出社を混ぜつつ、フルリモートで働かせていただいております。<br/>
大変ありがたいことです。</p>

<p>育児と家事と仕事で目が回るようでテレビなんてほとんど見れません。<br/>
シングルで育てている人には頭があがりませんね。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>今の仕事ではHeroku上でアプリケーション動かしているんですが、AddonでNewRelic足したら<br/>
NewRelic上でAlertの設定や各種変更動作ができない。</p>

<p>Userの設定をみると</p>

<p>チーム名@herokumanager.com</p>

<p>という見慣れないOwner権限を持ったユーザとUserロールの自分のみ。<br/>
色々と調べて見ましたが、最初にAddonを入れた時に連携するのにユーザが必要で暫定的に上記のユーザが作られるっぽい。</p>

<p><a href="https://discuss.newrelic.com/t/authorization-for-heroku-users/52967">https://discuss.newrelic.com/t/authorization-for-heroku-users/52967</a><br/>
<a href="https://discuss.newrelic.com/t/heroku-user-authorization/53121">https://discuss.newrelic.com/t/heroku-user-authorization/53121</a></p>

<p>正しい方法はわかりませんがしばらく調べてもわからなかったので潔くチケットをオープンしてNewRelicのサポートに自分のユーザをAdminにしてくれと夕方お願いしたら夜にはAdminになりました。</p>

<p>何か詰まっている人がいればサポートに投げるといいです。<br/>
誰かの参考になれば。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[自転車用ロッドホルダー]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2017/12/07/cycle-lod-holder/"/>
        <updated>2017-12-07T09:40:05+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2017/12/07/cycle-lod-holder</id>
        <content type="html"><![CDATA[<p>自転車のチェーンが度々外れるようになってきてしまったので<br/>
これを機に電動アシスト付きの自転車の購入を検討しました。<br/>
どうせなら車をどこかに止めて、そこから釣り場まで自転車で行ったりできるように車に積載可能なサイズを探しました。</p>

<p>実際に購入して、ロッドケースにまとめて竿をいれて担いで自転車乗っていたんですが、<br/>
自転車漕ぐ時に邪魔だし車の横すり抜ける時にぶつけそうになるので何かいい持ち運び方ないかと探していましたらいいのがありました。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>  
     (adsbygoogle = window.adsbygoogle || []).push({});  
</script>


<p></p>

<p>100均に売っている傘ホルダーです。</p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20171206/IMG_3184.jpg" data-lightbox="takasukaihinkouen" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20171206/IMG_3184.jpg"><br/>
</a></p>

<p>左右に取り付けるとこんな感じ。</p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20171206/IMG_3185.jpg" data-lightbox="takasukaihinkouen" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20171206/IMG_3185.jpg"><br/>
</a></p>

<p><a href="http://yoshitsugufujii.github.io/images/blog/20171206/IMG_3186.jpg" data-lightbox="takasukaihinkouen" data-title=""/><br/>
  <img src="http://yoshitsugufujii.github.io/images/blog/20171206/IMG_3186.jpg"><br/>
</a></p>

<p>移動がめちゃめちゃ楽になりました。<br/>
投げ竿などの竿ジリが長いものも上の留めるところにリールをひっかければ持ち運び可能です。</p>

<p>ちなみに自転車はこれを購入しました。<br/>
座席を少し前に出せばVoxyとかであれば詰めます。<br/>
ただサドルが硬くてずっと乗ってると股間が痛くなりますね。</p>

<table  border="0" cellpadding="5" style="border:none"><tr><td valign="top" style="border:none"><a href="https://hb.afl.rakuten.co.jp/hgc/g00pm4a6.4dryw6dc.g00pm4a6.4dryx09f/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fnextr%2Fpanasonic-jconcept%2F&m=http%3A%2F%2Fm.rakuten.co.jp%2Fnextr%2Fi%2F10003997%2F" target="_blank" ><img src="https://thumbnail.image.rakuten.co.jp/@0_mall/nextr/cabinet/05240708/imgrc0069940876.jpg?_ex=128x128" border="0" style="margin-right:10px" /></a></td><td valign="top" style="border:none;text-align:left"><div class="kaerebalink-name" style="margin-bottom:10px;line-height:120%"><a href="https://hb.afl.rakuten.co.jp/hgc/g00pm4a6.4dryw6dc.g00pm4a6.4dryx09f/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fnextr%2Fpanasonic-jconcept%2F&m=http%3A%2F%2Fm.rakuten.co.jp%2Fnextr%2Fi%2F10003997%2F" target="_blank" >パナソニック　Jコンセプト　2017モデル 【送料無料】【電動自転車　自転車　電動アシスト自転車 20インチ】</a></div><div class="kaerebalink-detail" style="margin-bottom:5px;"></div><table style="border:none;margin-top:10px"><tr><td style="border:none;text-align:left;"><div class="shoplinkrakuten" style="margin-right:5px"><a href="https://hb.afl.rakuten.co.jp/hgc/16102ad8.0804351d.16102ad9.09702e1c/?pc=http%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2FJ%25E3%2582%25B3%25E3%2583%25B3%25E3%2582%25BB%25E3%2583%2597%25E3%2583%2588%2F-%2Ff.1-p.1-s.1-sf.0-st.A-v.2%3Fx%3D0%26scid%3Daf_ich_link_urltxt%26m%3Dhttp%3A%2F%2Fm.rakuten.co.jp%2F" target="_blank" >楽天市場</a></div><div class="shoplinkamazon" style="margin-right:5px"><a href="http://www.amazon.co.jp/gp/search?keywords=J%E3%82%B3%E3%83%B3%E3%82%BB%E3%83%97%E3%83%88&__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&tag=gogosakura-22" target="_blank" >Amazon</a></div></td><td style="vertical-align:bottom;padding-left:10px;font-size:x-small;border:none">by <a href="http://kaereba.com" rel="nofollow" target="_blank">カエレバ</a></td></tr></table></font></td></tr></table>

]]></content>
    </entry>
    
</feed>
