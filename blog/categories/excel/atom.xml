<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

    <title><![CDATA[Category: excel | なんとなく日々徒然と]]></title>
    <link href="http://yoshitsugufujii.github.io/blog/categories/excel/atom.xml" rel="self"/>
    <link href="http://yoshitsugufujii.github.io/"/>
    <updated>2016-04-29T14:59:05+09:00</updated>
    <id>http://yoshitsugufujii.github.io/</id>
    <author>
        <name><![CDATA[Yoshitsugu Fujii]]></name>
        
      </author>
    <generator uri="http://octopress.org/">Octopress</generator>

    
    <entry>
        <title type="html"><![CDATA[Axlsxでセルの中の斜線を引く]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2015/07/28/axlsx-diagonal-border/"/>
        <updated>2015-07-28T18:55:24+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2015/07/28/axlsx-diagonal-border</id>
        <content type="html"><![CDATA[<p>またまた中々見つけられなかったテクニック。<br/>
セルの内部に斜線をひくです。</p>

<p>連日の調査で疲れます。</p>

<!-- more -->


<p>さくっと結論です。<br/>
edgesにdiagonalを指定して、diagonal_upかdiagonal_downにtrueを指定するです。<br/>
edgesにdiagonalを指定しろなんてどこにも書いてなかったので大変でした。</p>

<p>コードにするとこうです。</p>

<pre><code class="ruby">require 'axlsx'

package = Axlsx::Package.new
sheet = package.workbook.add_worksheet(name: 'lists')

diagonal_up = sheet.styles.add_style(
                              {
                               :border =&gt; {
                                 :edges =&gt; [:diagonal],
                                 :color =&gt; "000000",
                                 :style =&gt; :thin,
                                 diagonal_up: true
                               }
                              }
                            )
diagonal_down = sheet.styles.add_style(
                              {
                               :border =&gt; {
                                 :edges =&gt; [:diagonal],
                                 :color =&gt; "000000",
                                 :style =&gt; :thin,
                                 diagonal_down: true
                                }
                              }
                            )

diagonal_both = sheet.styles.add_style(
                              {
                               :border =&gt; {
                                 :edges =&gt; [:diagonal],
                                 :color =&gt; "000000",
                                 :style =&gt; :thin,
                                 diagonal_down: true,
                                 diagonal_up: true
                               }
                              }
                            )


sheet.add_row(['斜線1'], style: diagonal_up)
sheet.add_row([''])
sheet.add_row(['斜線2'], style: diagonal_down)
sheet.add_row([''])
sheet.add_row(['斜線3'], style: diagonal_both)

package.serialize('test.xlsx')
</code></pre>

<p><img src="/images/blog/2015-07-28.png" alt="Axlsx border diagonal" /></p>

<p>もしくはこれでもいけます。</p>

<pre><code class="ruby">require 'axlsx'

package = Axlsx::Package.new
sheet = package.workbook.add_worksheet(name: 'lists')

diagonal_style = sheet.styles.add_style(
                              {
                               :border =&gt; {
                                 :edges =&gt; [:left, :right],
                                 :color =&gt; "000000",
                                 :style =&gt; :thin 
                               }
                              }
                            )

br = package.workbook.styles.borders[package.workbook.styles.cellXfs[diagonal_style].borderId]
br.diagonalUp = true
br.diagonalDown = true
br.prs &lt;&lt; Axlsx::BorderPr.new(
  name: :diagonal,
  color: Axlsx::Color.new(rgb: '000000'),
  style: :thin,
)


sheet.add_row(['斜め線をひく'], style: diagonal_style)

package.serialize('test.xlsx')
</code></pre>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[Axlsxで縦書き]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2015/07/27/orientation-xlvertical-with-axlsx/"/>
        <updated>2015-07-27T18:19:53+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2015/07/27/orientation-xlvertical-with-axlsx</id>
        <content type="html"><![CDATA[<p>Axlsxでセルの内容を縦書きにする方法がわかったので日記に記します。<br/>
セルに角度を付ける方法は見つかったんですが、縦書きにする方法が全然見つからずかなりはまりました。</p>

<!-- more -->


<p>VBAだと縦書きはこう設定できますね。</p>

<pre><code class="vbnet">Range("D2").Orientation = xlVertical  
</code></pre>

<p>色々と調べて、xlVerticalの値である-4166をセットしていしてみたりしましたがなかなかうまくゆかず。<br/>
色々と検索して、最終的にcellXfsというキーワードからなぜか<a href="http://bbs.wankuma.com/index.cgi?mode=al2&amp;namber=5358&amp;KLOG=15">C# vb.netの質問掲示板</a>で発見しましした(圧倒的感謝!)<br/>
textRotationを255を指定すればいけるそうです。</p>

<pre><code class="ruby">require 'axlsx'

package = Axlsx::Package.new
sheet = package.workbook.add_worksheet(name: 'lists')

vertical_text = sheet.styles.add_style(
    {
      alignment: { 
        horizontal: :center,
        vertical: :center ,
        textRotation: 255
      }
    }
)

sheet.add_row(['とっても長いテキスト', '短いテキスト'], style: vertical_text)

package.serialize('test.xlsx')
</code></pre>

<p>できないのかもと本気で諦めかけていたので出来た時には変な声がでてしまいました。</p>

<p><img src="/images/blog/2015-07-27.png" alt="Axlsx Orientaion xlVertical" /></p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[Axlsxでセルのなかのテキストに部分的にスタイルを当てる]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2015/07/14/partially-change-string-style-in-cell-with-axlsx/"/>
        <updated>2015-07-14T20:28:04+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2015/07/14/partially-change-string-style-in-cell-with-axlsx</id>
        <content type="html"><![CDATA[<p>Axlsxでセルの中の文字にスタイルをあてる方法です 。<br/>
Axlsx::RichTextを使います。<br/>
太字、斜体、打ち消し戦、アンダーライン、色変更に対応しております。</p>

<!-- more -->


<pre><code class="ruby">p = Axlsx::Package.new
p.use_shared_strings = true
wb = p.workbook
wrap_text = wb.styles.add_style({:alignment =&gt; {:horizontal =&gt; :center, :vertical =&gt; :center, :wrap_text =&gt; true}}  )
rt = Axlsx::RichText.new
rt.add_run('I\'m bold, ', :b =&gt; true)
rt.add_run('I\'m italic, ', :i =&gt; true)
rt.add_run('I\'m strike' + "\n", :strike =&gt; true)
rt.add_run('I\'m bold, italic and strike' + "\n", :b =&gt; true, :i =&gt; true, :strike =&gt; true)
rt.add_run('I\'m style-less :D')
rt.add_run('underlined and red.', :u =&gt; :double, :color =&gt; 'FF0000')
wb.add_worksheet(:name =&gt; "RichText") do | sheet |
sheet.add_row [rt], :style =&gt; wrap_text
end
p.serialize 'rich_text.xlsx'
</code></pre>

<p><img src="/images/blog/2015-07-14%2020.30.19.png" alt="完成イメージ" /></p>

<p>Axlsxなんでもできますね！</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[Axlxsを使って新規ファイルを作って、RubyXLで読み出す話]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2014/12/18/20141218200736/"/>
        <updated>2014-12-18T20:07:00+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2014/12/18/20141218200736</id>
        <content type="html"><![CDATA[<p>どんどんtipsがニッチになっていきますね。</p>

<p>Axlxsで作ったファイルがRubyXLで読み取れませんでした。<br/>
一度エクセルで開いて保存すると読み取れるようになる。</p>

<p>RubyXLでAxlxsで作成したファイルを読み込むと数値とかは辛うじて所々取れていたので文字コードかと思って色々やってみましたが、このページで解決</p>

<p><a href="https://github.com/randym/axlsx/issues/349">Strings outputted not seen by rubyXL ? Issue   #349 ? randym/axlsx ?
GitHub</a></p>

<p>pkg = Package.create<br/>
したら<br/>
pkg.use  <em>shared  </em>strings = true<br/>
する必要があるみたいでした。</p>

<p>これで無事に読みだすことができました。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[AxlsxでExcelファイルをcell単位でprotectionをした話]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2014/12/17/20141217122846/"/>
        <updated>2014-12-17T12:28:00+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2014/12/17/20141217122846</id>
        <content type="html"><![CDATA[<p>Axlsxでエクセルと戯れる日々です。<br/>
2シート目とかにマスタデータを保持しておいて、1シート目でプルダウンでマスタデータを選ばせたりしています。<br/>
変更できないように2シート目はシート全体を保護しております。</p>

<p>今日はAxlsxでセルの保護をしたお話です。</p>

<p>これググっても全然出てきませんでした。</p>

<p>結論から言うとこれでできます。</p>

<pre><code class="ruby">require 'axlsx'
require "securerandom"

package = Axlsx::Package.new
sheet = package.workbook.add_worksheet(name: 'lists')
sheet.sheet_protection.password = SecureRandom.uuid
locked = package.workbook.styles.add_style :locked =&gt; true
unlocked = package.workbook.styles.add_style :locked =&gt; false

sheet.add_row(['品名', '単価', '数量', '計'], style: unlocked )
sheet.add_row(['にんじん',    80, 1,      '=B2*C2'], style: unlocked)

sheet.rows[0].cells[0].style = locked # A1をロック(lock cell =&gt; A1)

package.serialize('test.xlsx')
</code></pre>

<p>この答えの出し方が最終的にRubyのことはRubyに聞くという方式で解決したのですが、<br/>
この解決の仕方がRubyエンジニアっぽいなと思ったのでどうやってこの結論に辿り着いたかダラダラ書こうかと思います。</p>

<p>まずセルの保護をしたいという要件がありました。<br/>
コピペエンジニアの端くれとしてまずはググります。</p>

<p>行単位のロックのお話は見つけましたが、セルの保護ではいい結果がありません。<br/>
<a href="http://stackoverflow.com/questions/19051049/how-do-i-protect-header-rows-but-allow-to-enter-new-rows-using-axlsx">ruby on rails 3 - How do I protect header rows but allow to enter new
rows using AXLSX? - Stack
Overflow</a></p>

<p>テストは下手なドキュメントよりも役にたつと誰かが言っていたので(実際の使い方のサンプルが見れるので)Axlsxのテストを見てみます。<br/>
bundle open axlsxでaxlsxのインストールされたディレクトリを開いて、grep
protectとかやってみます。<br/>
いくつかヒットしたのでソースを見てみますがなんのこっちゃわかりません感じです。</p>

<p>とりあえずgrepでひっかかった<br/>
Axlsx::CellProtection.new<br/>
をキーワードにグーグルで検索してみますが有用な情報は皆無です。</p>

<p>一旦途方にくれます。コーヒーとか飲みます。</p>

<p>おもむろに再度irbを立ち上げます。<br/>
とりあえず怪しいものがないかコンソールから確認していってみることにします</p>

<pre><code class="ruby">require 'axlsx'
package = Axlsx::Package.new
sheet = package.workbook.add_worksheet(name: 'lists')

sheet.add_row(['品名', '単価', '数量', '計'])
</code></pre>

<p>と打ちます。</p>

<p>cellに保護をかけたいのだからcellオブジェクトにプロパティがあるんじゃないかとあたりをつけます。</p>

<p>sheet.cellとうちます。そんなんねーよと返ってきます。<br/>
sheet.cells と打ちます。なんかコンソールに文字がたくさんでます。</p>

<p>A1のセルを取得してみます。<br/>
sheet.cells[0,0]とうちます。空の配列が返ってきます。<br/>
sheet.cells[0]とうちます。なんか一杯でてきます。<br/>
sheet.cells[0].classとうちます。   # =  > Axlsx::Cell<br/>
お、なんかいいの返ってきました。<br/>
sheet.cells[0].methods.grep(/protect/)とかうってみます。
[:protected  _methods]しか返ってきません。<br/>
一回煮詰まります。
sheet.cells[0].valueとかここで色々他のことをやってみますが、なかなかうまくいきません。</p>

<p>そもそもセル単位で値とか設定できるんかと思いつきます。<br/>
ググります。見つけます。</p>

<p><a href="http://stackoverflow.com/questions/18178196/modify-specific-cell-value-using-axlsx-gem-given-the-column-number-and-row-numer">ruby on rails - Modify specific cell value using Axlsx gem given the
column number and row numer - Stack
Overflow</a></p>

<p>特定のセルを取得するのは以下の方法でした。<br/>
sheet.rows[0].cells[0]</p>

<p>sheet.rows[0].cells[0].methodsでメソッド一回全部のメソッドを出してみます。</p>

<p>sheet.rows[0].cells[0].pos   # =  > [0,0]<br/>
とか<br/>
sheet.rows[0].cells[0].reference   # =  >   $A  $1<br/>
とか面白そうなメソッドがあります。</p>

<p>その中にstyle=というメソッドを見つけました。<br/>
これってひょっとして行単位のロックであったロックの書式を設定できるのではないかと推測します。</p>

<p>そして出きたのが冒頭のコードです。</p>

<p>sheet.rows[0].cells[0].style = locked<br/>
だけでは不十分で<br/>
sheet.sheet  _protection.password<br/>
でパスワードを設定しないといけないとか、保護をかけて必要な所をlockしたりunlockしたりしないといけないとか色々とはまりながらもなんとか答えを出せました。<br/>
今回は運も味方してくれたかなぁという気もします。</p>

<p>困ったときはインタラクティブにどんなメソッドがあるかどんな値が設定されているか確認しながら<br/>
試しながらやることで問題が解決できるというのは素晴らしいと思いました。</p>
]]></content>
    </entry>
    
</feed>
