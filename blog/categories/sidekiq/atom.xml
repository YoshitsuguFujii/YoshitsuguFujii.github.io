<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

    <title><![CDATA[Category: sidekiq | なんとなく日々徒然と]]></title>
    <link href="http://yoshitsugufujii.github.io/blog/categories/sidekiq/atom.xml" rel="self"/>
    <link href="http://yoshitsugufujii.github.io/"/>
    <updated>2015-04-06T13:31:43+09:00</updated>
    <id>http://yoshitsugufujii.github.io/</id>
    <author>
        <name><![CDATA[Yoshitsugu Fujii]]></name>
        
      </author>
    <generator uri="http://octopress.org/">Octopress</generator>

    
    <entry>
        <title type="html"><![CDATA[sidekiqでcould not obtain a database connection]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2015/04/06/sidekiq-has-connection-over-db-pool-size/"/>
        <updated>2015-04-06T13:13:17+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2015/04/06/sidekiq-has-connection-over-db-pool-size</id>
        <content type="html"><![CDATA[<p>sidekiqを運用していたら以下のようなエラーが発生<br/>
<code>
could not obtain a database connection within 5.000 seconds (waited 5.000 seconds)  
activerecord-4.1.4/lib/active_record/connection_adapters/abstract/connection_pool.rb:190:in `block in wait_poll'  
</code></p>

<!-- more -->


<p>sidekiqのconcurrencyの設定が25でdatabase.ymlのpoolサイズが5でした。<br/>
sidekiqのconcurrencyとpoolは揃えるのがデフォみたいです。</p>

<p><a href="http://railscasts.com/episodes/366-sidekiq?language=ja&amp;view=asciicast">Sidekiq-RailsCast</a></p>

<blockquote><p>データベースの設定ファイルのプールサイズの上限にも気をつけるべきです。
これはデフォルトでは5になっているので、データベースに同時に接続できるスレッド数は5までです。この制限を上げておく方がいいでしょう。
Sidekiqはデフォルトでは25個までのジョブを同時に実行できるので、poolオプションを同じ数に設定しておくのがいいでしょう。
ただし、最適値は設定によって変わります。</p></blockquote>

<p>対策としてはこちらの記事のSidekiqの項が参考になるかと思います。<br/>
<a href="https://jeremy.wordpress.com/2014/06/02/activerecord-connection-pool-unicorn-sidekiq://jeremy.wordpress.com/2014/06/02/activerecord-connection-pool-unicorn-sidekiq/">How to use a different ActiveRecord connection pool between Unicorn and Sidekiq?</a></p>

<p>こちらはDatabase.ymlにsidekiq用の設定を作ってconfig/initializerでその設定を読み込むというものですね。<br/>
色々な所に落とし穴はあるものです。</p>
]]></content>
    </entry>
    
</feed>
