<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

    <title><![CDATA[Category: ruby on rails | なんとなく日々徒然と]]></title>
    <link href="http://yoshitsugufujii.github.io/blog/categories/ruby-on-rails/atom.xml" rel="self"/>
    <link href="http://yoshitsugufujii.github.io/"/>
    <updated>2017-11-24T22:21:22+09:00</updated>
    <id>http://yoshitsugufujii.github.io/</id>
    <author>
        <name><![CDATA[Yoshitsugu Fujii]]></name>
        
      </author>
    <generator uri="http://octopress.org/">Octopress</generator>

    
    <entry>
        <title type="html"><![CDATA[rails5でafter_commitが動かなくなってしまった]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2017/10/31/rails-after-commit/"/>
        <updated>2017-10-31T10:27:08+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2017/10/31/rails-after-commit</id>
        <content type="html"><![CDATA[<p>ITネタです。すいません。<br/>
railsのモデルデータに変更が加えられたらelasticsearchのデータをafter_commitで更新するようにしているのですが。</p>

<pre><code class="ruby  ">after_commit :index_elasticsearch_document, on: [:create, :update]  
after_commit :delete_elasticsearch_document, on: [:destroy]  
</code></pre>

<p>Rails5.1.4にしたら設定したcallbackが走らなくなってしまいました。<br/>
困っている人結構いるような気がするんですがどうなんでしょうかね。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>  
     (adsbygoogle = window.adsbygoogle || []).push({});  
</script>


<p></p>

<p>onオプションをつけると動かなくて外すと動きます。<br/>
どうもcallbackが処理される過程の<a href="https://apidock.com/rails/v4.0.2/ActiveRecord/Transactions/transaction_include_any_action%3F">transaction_include_any_action?</a>によるどの操作(insert, update, destroy)での更新かとonオプションによる一致が正常に判定されず動かないようです。<br/>
ぐぐってみるとヒットするのはこのあたりでしょうか。</p>

<p><a href="https://github.com/rails/rails/issues/29554">after_create_commit and after_update_commit alias don&rsquo;t always run when next to each other #29554</a></p>

<p><a href="https://github.com/rails/rails/issues/29318">after_commit doesn&rsquo;t work with optimistic locking #29318</a></p>

<p>これのうち下のリンクが正解でした。<br/>
修正PRは<a href="https://github.com/rails/rails/pull/29096">これ</a>ですが、まだマージされてませんね。<br/>
この<a href="https://github.com/rails/rails/commit/371c083fb0620efebf7bd0188a66486403e12ecc">コミット</a>が原因のようです。
5.0.2ではうごくみたいですw</p>

<p>ちなみに関わっている案件の場合は正確にはcomposite_primary_keysを使っているのでcomposite_primary_keysの方の悲観的ロックが原因でした。<br/>
メソッドオーバーライドしているのでほぼ同じ現象です。</p>

<p><a href="https://github.com/composite-primary-keys/composite_primary_keys/blob/master/lib/composite_primary_keys/locking/optimistic.rb#L43">ここ</a>で<a href="https://github.com/rails/rails/pull/29096">PR</a>と同じように@_trigger_update_callbackを設定すれば治ります。</p>

<p>ただパッチをあてるのもなって感じなのでモデル側でこうなおしました。</p>

<pre><code class="ruby  ">class ElasticsearchNoModel &lt; ApplicationRecord  
  def _update_record(*args)  
    affected_rows = super  
    if affected_rows == 1  
      @_trigger_update_callback = true  
    end  
  end  
end  
</code></pre>

<p>create時とupdate時はこれで治りましたがdestroyの時がこれだとまだうごきません。<br/>
ちなみに今関わっている案件ではparanoia使ってます。</p>

<p><a href="https://github.com/rubysherpas/paranoia/issues/418">after_commit with on: option doesn&rsquo;t work at Rails 5.1.3 #418</a></p>

<p>issueあがってますがリアクションありませんね。</p>

<p>ソース読んでこう直しました。</p>

<pre><code class="ruby  ">class ElasticsearchNoModel &lt; ApplicationRecord  
  def destroy  
    @_trigger_destroy_callback = true  
    super  
  end  
end  
</code></pre>

<p>@_trigger_destroy_callbackをsuperの前に設定するのはparanoiaのメソッドがdeleted_atの更新とrun_callbackを同一メソッドでやっているためです(なるべくパッチorメソッドをいじりたくないので先に設定してしまっています)</p>

<p>これで無事にafter_commitが動くようになりました。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[特定のユーザに送られるメールを全てキャンセル]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2017/10/26/cancel-mail/"/>
        <updated>2017-10-26T11:36:00+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2017/10/26/cancel-mail</id>
        <content type="html"><![CDATA[<p>ナチュラムでジョイナス2000が2000円切っていたのでぽちり。<br/>
昨日届きましたがやっぱりちょっと安い感じがありました。<br/>
もう千円だしてアリビオ買えばよかったかも。</p>

<p>釣り記事の合間のITネタ。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>  
     (adsbygoogle = window.adsbygoogle || []).push({});  
</script>


<p></p>

<p>usersテーブルにlockフラグを持っているなどある条件によってメールを送信するしないをアプリ全体で制御する方法。<br/>
interceptorを使います。</p>

<pre><code class="ruby    "># config/initializers/mail_interceptor.rb  

ActionMailer::Base.register_interceptor(MailInterceptor)  
</code></pre>

<pre><code class="ruby    "># lib/mail_interceptor.rb  

class MailInterceptor  
  def self.delivering_email(email)  
    # lock中のユーザーには送らない  
    user = User.find_by(email: email.to)  
    if user.lock_flag?  
      email.perform_deliveries = false  
    end  
  end  
end  
</code></pre>

<p>perform_deliveriesにfalseを設定するとメールが送られなくなります。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[Doorkeeperでトークンの有効期限切れをさせない]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2017/10/19/doorkeer-expire-token-desabled/"/>
        <updated>2017-10-19T11:59:10+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2017/10/19/doorkeer-expire-token-desabled</id>
        <content type="html"><![CDATA[<p>釣りばっかりの記事の連投にぶっこんですいません。<br/>
IT技術ネタです。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>  
     (adsbygoogle = window.adsbygoogle || []).push({});  
</script>


<p></p>

<p>こちらを読みまして。<br/>
<a href="https://qiita.com/r7kamura/items/3e03471e02ea9ab5902a">アクセストークンに有効期限を設けるべきかどうか</a></p>

<p>たしかにそうだよなと思ったのとDoorkeeper使った認証基盤にクライアントがアクセスするときに、token失効により、他ユーザの情報などがとれないことがったりしたのでtoken失効させないことにします。</p>

<pre><code class="ruby  "># config/initializers/doorkeeper.rb  

Doorkeeper.configure do  
  access_token_expires_in nil # &lt;- こうする  
end  
</code></pre>

<p>参考<br/>
<a href="https://github.com/doorkeeper-gem/doorkeeper/wiki/Customizing-Token-Expiration#access-token">Customizing Token Expirationupdate oauth_access_tokens set expires_in = null</a></p>

<p>もうすでに設定されているアプリでこちら無効にしたい場合は<br/>
expires_inにnullを設定すればいいようです。</p>

<pre><code class="sql  ">update oauth_access_tokens set expires_in = null  
</code></pre>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[Railsでtextとhtmlのviewを用意するもmultipart/alternativeにならない問題]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2017/09/12/alternative-not-working/"/>
        <updated>2017-09-12T18:36:54+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2017/09/12/alternative-not-working</id>
        <content type="html"><![CDATA[<p>Ruby: 2.4.1<br/>
Rails: 4.2.8</p>

<p>ActionMailerでhogehoge.html.hamlとhogehoge.text.hamlを用意しているのにtext/htmlの形式でしか送信されなくてはまりかけた。<br/>
hogehoge.text.hamlをhogehoge.text.erbに直したらmultipart/alternativeになってくれた。</p>

<p>textの方はerbじゃないとダメっぽい。</p>

<p>そしてletter_openerってalternativeなメールの時って右上にHTMLメールとプレーンテキストメールの切り替えリンクが付いているんですね。<br/>
めっちゃ便利！</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[S3からRailsを介して大きなファイルをストリーミングダウンロードさせる]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2017/06/29/large-s3-file-relay/"/>
        <updated>2017-06-29T15:25:15+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2017/06/29/large-s3-file-relay</id>
        <content type="html"><![CDATA[<h3>近況とか</h3>

<p>最近の藤井は月〜木は新橋の方面で働き金曜日は在宅で仕事させてもらっています。<br/>
言語は相変わらずRubyでFWはRubyOnRailsですね。<br/>
Firebase触ったり、WebRTCに触ったり、はじめてガチでHeroku使ったりしています。</p>

<p>自分が業界に入りたての頃はこういったサービスがなかったので1からどう作るかって感じでしたが、<br/>
最近はどうやってサービスを組み合わせて作るかって感じに変化したように思います。<br/>
サービスの学習コストの方が高めですかね。</p>

<p>Macbook Airの日本語キーボードから英字配列のhhkbに移行しました。<br/>
:が打ちにくくて最初文句ブーブーでしたが、慣れるとたしかに英字配列の方がやりやすい気がします。<br/>
職場と自宅で持ち運びがめんどくさかったので二台買いました。<br/>
hhkbの墨とtype-sです。<br/>
お金使いすぎで鼻血出そうです。</p>

<p>帰宅ランは続けていて調子いいときは10キロぐらい走ります。<br/>
だいたい7、8キロぐらいを目安に走っています。<br/>
江戸川沿い走るの最高に気持ちいいです。</p>

<!-- more -->


<p></p>

<h3>表題の件</h3>

<p>S3のファイルをRailsを中継してクライアントにストリーミングダウンロードする処理書きました。<br/>
Httparty使ってます。Httpartyでstreaming download楽ですねー。</p>

<pre><code class="ruby">class AttachmentController &lt; ApplicationController
  include ActionController::Live

  def download
    attachment = Attachment.find(params[:id])
    begin
      self.response.headers["Content-Type"] = attachment.content_type
      self.response.headers["Content-Length"] = attachment.file_size
      self.response.headers["Content-Disposition"] = "attachment; filename=#{attachment.file_before_type_cast}"
      self.response.headers["Content-Transfer-Encoding"] = "binary"
      self.response.headers["Last-Modified"] = attachment.updated_at.ctime.to_s
      HTTParty.get(attachment.url, stream_body: true) do |fragment|
        self.response.stream.write fragment
      end
    rescue ActionController::Live::ClientDisconnected  # キャンセルされた場合
      # nop
    ensure
      response.stream.close
    end
  end
end
</code></pre>

<p>Puma使いましょう。webrickとかthinは対応していません。</p>

<p>config/environments/development.rbに以下の設定を追加。</p>

<pre><code class="ruby">config.cache_classes = true
config.eager_load = true
</code></pre>

<p>あとは<code>bundle exec rails s Puma</code>して試してみてください。</p>
]]></content>
    </entry>
    
</feed>
