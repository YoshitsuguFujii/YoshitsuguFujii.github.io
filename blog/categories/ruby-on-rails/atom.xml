<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

    <title><![CDATA[Category: ruby on rails | なんとなく日々徒然と]]></title>
    <link href="http://yoshitsugufujii.github.io/blog/categories/ruby-on-rails/atom.xml" rel="self"/>
    <link href="http://yoshitsugufujii.github.io/"/>
    <updated>2018-01-29T15:09:17+09:00</updated>
    <id>http://yoshitsugufujii.github.io/</id>
    <author>
        <name><![CDATA[Yoshitsugu Fujii]]></name>
        
      </author>
    <generator uri="http://octopress.org/">Octopress</generator>

    
    <entry>
        <title type="html"><![CDATA[Doorkeeperでパスワードが変更されたらクライアント側でログアウトさせる]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/01/29/logout-when-doorkeeper-password-change/"/>
        <updated>2018-01-29T14:26:19+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/01/29/logout-when-doorkeeper-password-change</id>
        <content type="html"><![CDATA[<p><a href="https://github.com/doorkeeper-gem/doorkeeper">Doorkeeper</a>を使ったoauthの仕組みでプラットフォーム側でパスワード変更の処理を書いててパスワード変更しても現在ログイン状態のユーザーがログアウトされなくて久しぶりにどっぷりハマったのでメモ。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>セッションストアであるredisを見ると同じユーザーで二つのブラウザでログインすると２つ違うsession keyで保持されている。<br/>
このセッションの中身は</p>

<p>一つ目はwarden key(そのままだとユーザID)<br/>
二つ目はencrypted_password</p>

<p>となっているようだ。</p>

<p><a href="https://stackoverflow.com/a/23683925/2223472">https://stackoverflow.com/a/23683925/2223472</a></p>

<p>Doorkeeperを使っているクライアントではoauth認証を使うのでパスワードを使っていない<br/>
そのため二つめencrypted_passwordの値は空になっている。</p>

<p>この二つの値を使って認証しているようだ。</p>

<p>プラットフォーム側でパスワードを変更しても二つ目の値は相変わらず空のためクライアント側ではセッションの状況に変化なしとなり<br/>
そのままログインが保持されてしまう。</p>

<p>tokenを使ったりパスワードを渡す等があったりしたがこうした。</p>

<p>まず、 パスワード変更時刻をプラットフォーム側にcolumnとして追加。<br/>
パスワード変更時にupdateするようにする。</p>

<pre><code class="">class User &lt; ApplicationRecord  
  def reset_password(*args)  
    self.password_changed_at = Time.current  
    super  
  end  
end  
</code></pre>

<p>そしてクライアントサイドでは連携されたpassword_changed_atを使うようにする。</p>

<pre><code class="">class User &lt; ApplicationRecord  
  def authenticatable_salt  
    password_changed_at  
  end  
end  
</code></pre>

<p>これでパスワードが変更されるとクライアントのセッションの中身も変わり、<br/>
他のブラウザでログインしていても適切にログアウトされる。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[CircleCIでRuby2.5使おうとしたらbad interpreter]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/01/26/circle-ci-ver-one-ruby-two-five-bad-interpreter/"/>
        <updated>2018-01-26T18:51:07+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/01/26/circle-ci-ver-one-ruby-two-five-bad-interpreter</id>
        <content type="html"><![CDATA[<p>一度は成功していたのに急にCircleCI 1.0がこけるようになってしまいました。</p>

<pre><code class="">set ruby version to 2.5.0  
</code></pre>

<p>で</p>

<pre><code class="">ruby-2.5.0 - #generating default wrappers|/-\|/-\|.-\|/-\|/-.|/-\|/-\|.-\|/-\|/-.|/-\|/-\|.-\|/-\|/-.|/-\|/-\|.-\|/-\|.  
Using /home/ubuntu/.rvm/gems/ruby-2.5.0  
/home/ubuntu/.rvm/scripts/override_gem: /home/ubuntu/.rvm/rubies/ruby-2.5.0/bin/gem: /home/travis/.rvm/rubies/ruby-2.5.0/bin/ruby: bad interpreter: No such file or directory  
</code></pre>

<p>のようなエラー。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>調べるとこんなツイートが&hellip;</p>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="en" dir="ltr"><a href="https://twitter.com/circleci?ref_src=twsrc%5Etfw">@circleci</a> I&#39;m getting build failures on ruby 2.5 - it looks like the `gem` command is using a shebang that references a non-existent `/home/travis` directory <a href="https://t.co/UcZREdK2Q8">pic.twitter.com/UcZREdK2Q8</a></p>&mdash; Justin Rhinesmith (@jerhinesmith) <a href="https://twitter.com/jerhinesmith/status/956311677426741248?ref_src=twsrc%5Etfw">2018年1月24日</a></blockquote>


<p></p>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<p></p>

<p>sshするとshebangでエラーになっている同じ現象でした。<br/>
そしてこんなチケットが&hellip;</p>

<p><a href="https://discuss.circleci.com/t/ruby-2-5-0-builds-failing-on-circleci-1-0-due-to-missing-home-travis/19620">Ruby 2.5.0 builds failing on CircleCI 1.0 due to missing <code>/home/travis</code></a></p>

<p>解決しているらしいのですが、普通にエラーでますがな&hellip;<br/>
マニュアルで</p>

<pre><code class="">machine:  
  pre:  
    - sudo ln -s /opt/circleci /home/travis  
</code></pre>

<p>を仕込もうとしたらもうありますエラー。<br/>
そして微妙にパスも違う。</p>

<p>結論。こうしてなおしました。</p>

<pre><code class="">machine:  
  pre:  
    - sudo rm -rf /home/travis  
    - sudo ln -s /home/ubuntu /home/travis  
  ruby:  
    version: 2.5.0  
</code></pre>

<p>すぐなおってくれると思いますが、お困りの人がいたら上記で治ります。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[ridgepoleの部分インデックスで毎回createとdrop indexをさせない書き方]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/01/22/ridgepole-partial-uniq-index/"/>
        <updated>2018-01-22T14:44:35+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/01/22/ridgepole-partial-uniq-index</id>
        <content type="html"><![CDATA[<p>railsでparanoiaとか使っていて、<br/>
mysqlで論理削除にdeleted_atがnullかどうかで論理削除判定していると<br/>
dbのuniq indexで辛い感じになります。</p>

<p>postgresqlでは部分インデックスなるものがあり、deleted_atがnullのものをuniq制約の条件に含めないとかいうことができます。</p>

<p><a href="https://www.postgresql.jp/document/9.2/html/indexes-partial.html">部分インデックス</a></p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>ridgepoleではこう書くと毎回create index drop indexしません。</p>

<pre><code class="">add_index "users", ["email"], name: "uniq_email_idx", unique: true, where: '(deleted_at IS NULL)'  
</code></pre>

<p>本日は大雪らしいので早く帰りましょう。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[rails5でafter_commitが動かなくなってしまった]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2017/10/31/rails-after-commit/"/>
        <updated>2017-10-31T10:27:08+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2017/10/31/rails-after-commit</id>
        <content type="html"><![CDATA[<p>ITネタです。すいません。<br/>
railsのモデルデータに変更が加えられたらelasticsearchのデータをafter_commitで更新するようにしているのですが。</p>

<pre><code class="ruby  ">after_commit :index_elasticsearch_document, on: [:create, :update]  
after_commit :delete_elasticsearch_document, on: [:destroy]  
</code></pre>

<p>Rails5.1.4にしたら設定したcallbackが走らなくなってしまいました。<br/>
困っている人結構いるような気がするんですがどうなんでしょうかね。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>  
     (adsbygoogle = window.adsbygoogle || []).push({});  
</script>


<p></p>

<p>onオプションをつけると動かなくて外すと動きます。<br/>
どうもcallbackが処理される過程の<a href="https://apidock.com/rails/v4.0.2/ActiveRecord/Transactions/transaction_include_any_action%3F">transaction_include_any_action?</a>によるどの操作(insert, update, destroy)での更新かとonオプションによる一致が正常に判定されず動かないようです。<br/>
ぐぐってみるとヒットするのはこのあたりでしょうか。</p>

<p><a href="https://github.com/rails/rails/issues/29554">after_create_commit and after_update_commit alias don&rsquo;t always run when next to each other #29554</a></p>

<p><a href="https://github.com/rails/rails/issues/29318">after_commit doesn&rsquo;t work with optimistic locking #29318</a></p>

<p>これのうち下のリンクが正解でした。<br/>
修正PRは<a href="https://github.com/rails/rails/pull/29096">これ</a>ですが、まだマージされてませんね。<br/>
この<a href="https://github.com/rails/rails/commit/371c083fb0620efebf7bd0188a66486403e12ecc">コミット</a>が原因のようです。
5.0.2ではうごくみたいですw</p>

<p>ちなみに関わっている案件の場合は正確にはcomposite_primary_keysを使っているのでcomposite_primary_keysの方の悲観的ロックが原因でした。<br/>
メソッドオーバーライドしているのでほぼ同じ現象です。</p>

<p><a href="https://github.com/composite-primary-keys/composite_primary_keys/blob/master/lib/composite_primary_keys/locking/optimistic.rb#L43">ここ</a>で<a href="https://github.com/rails/rails/pull/29096">PR</a>と同じように@_trigger_update_callbackを設定すれば治ります。</p>

<p>ただパッチをあてるのもなって感じなのでモデル側でこうなおしました。</p>

<pre><code class="ruby  ">class ElasticsearchNoModel &lt; ApplicationRecord  
  def _update_record(*args)  
    affected_rows = super  
    if affected_rows == 1  
      @_trigger_update_callback = true  
    end  
  end  
end  
</code></pre>

<p>create時とupdate時はこれで治りましたがdestroyの時がこれだとまだうごきません。<br/>
ちなみに今関わっている案件ではparanoia使ってます。</p>

<p><a href="https://github.com/rubysherpas/paranoia/issues/418">after_commit with on: option doesn&rsquo;t work at Rails 5.1.3 #418</a></p>

<p>issueあがってますがリアクションありませんね。</p>

<p>ソース読んでこう直しました。</p>

<pre><code class="ruby  ">class ElasticsearchNoModel &lt; ApplicationRecord  
  def destroy  
    @_trigger_destroy_callback = true  
    super  
  end  
end  
</code></pre>

<p>@_trigger_destroy_callbackをsuperの前に設定するのはparanoiaのメソッドがdeleted_atの更新とrun_callbackを同一メソッドでやっているためです(なるべくパッチorメソッドをいじりたくないので先に設定してしまっています)</p>

<p>これで無事にafter_commitが動くようになりました。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[特定のユーザに送られるメールを全てキャンセル]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2017/10/26/cancel-mail/"/>
        <updated>2017-10-26T11:36:00+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2017/10/26/cancel-mail</id>
        <content type="html"><![CDATA[<p>ナチュラムでジョイナス2000が2000円切っていたのでぽちり。<br/>
昨日届きましたがやっぱりちょっと安い感じがありました。<br/>
もう千円だしてアリビオ買えばよかったかも。</p>

<p>釣り記事の合間のITネタ。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>  
     (adsbygoogle = window.adsbygoogle || []).push({});  
</script>


<p></p>

<p>usersテーブルにlockフラグを持っているなどある条件によってメールを送信するしないをアプリ全体で制御する方法。<br/>
interceptorを使います。</p>

<pre><code class="ruby    "># config/initializers/mail_interceptor.rb  

ActionMailer::Base.register_interceptor(MailInterceptor)  
</code></pre>

<pre><code class="ruby    "># lib/mail_interceptor.rb  

class MailInterceptor  
  def self.delivering_email(email)  
    # lock中のユーザーには送らない  
    user = User.find_by(email: email.to)  
    if user.lock_flag?  
      email.perform_deliveries = false  
    end  
  end  
end  
</code></pre>

<p>perform_deliveriesにfalseを設定するとメールが送られなくなります。</p>
]]></content>
    </entry>
    
</feed>
