<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

    <title><![CDATA[Category: ruby on rails | なんとなく日々徒然と]]></title>
    <link href="http://yoshitsugufujii.github.io/blog/categories/ruby-on-rails/atom.xml" rel="self"/>
    <link href="http://yoshitsugufujii.github.io/"/>
    <updated>2019-02-27T17:07:56+09:00</updated>
    <id>http://yoshitsugufujii.github.io/</id>
    <author>
        <name><![CDATA[Yoshitsugu Fujii]]></name>
        
      </author>
    <generator uri="http://octopress.org/">Octopress</generator>

    
    <entry>
        <title type="html"><![CDATA[GCSとActiveStorageを使った時に秘密鍵でエラー]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2019/02/27/gcs-private-key/"/>
        <updated>2019-02-27T16:57:03+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2019/02/27/gcs-private-key</id>
        <content type="html"><![CDATA[<p>サービスアカウントを発行して、キーを発行してその中身を</p>

<pre><code class="">bundle exec rails credentials:edit    
</code></pre>

<p>してstorage.ymlで読み出そうとした時にprivate_keyに改行があるためにうまくいかなかった。</p>

<!-- more -->




<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


<p>dumpを使えばおっけー</p>

<pre><code>Rails.application.credentials.gcs[:private_key].dump
</code></pre>

<p>全体はこう。</p>

<pre><code>google:
  service: GCS
  credentials:
    type: "service_account"
    project_id: &lt;%= Rails.application.credentials.gcs[:project_id] %&gt;
    private_key_id: &lt;%= Rails.application.credentials.gcs[:private_key_id] %&gt;
    private_key: &lt;%= Rails.application.credentials.gcs[:private_key].dump %&gt;
    client_email: &lt;%= Rails.application.credentials.gcs[:client_email] %&gt;
    client_id: &lt;%= Rails.application.credentials.gcs[:client_id] %&gt;
    auth_uri: "https://accounts.google.com/o/oauth2/auth"
    token_uri: "https://accounts.google.com/o/oauth2/token"
    auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs"
    client_x509_cert_url: &lt;%= Rails.application.credentials.gcs[:client_x509_cert_url] %&gt;
  project: ''
</code></pre>

<p>参考
<a href="https://github.com/rails/rails/blob/master/guides/source/active_storage_overview.md">https://github.com/rails/rails/blob/master/guides/source/active_storage_overview.md</a></p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[メソッドの引数の値を全部表示したい時]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2019/01/07/show-arguments-to-logs/"/>
        <updated>2019-01-07T16:44:35+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2019/01/07/show-arguments-to-logs</id>
        <content type="html"><![CDATA[<p>あけましておめでとうございます。<br/>
今年もよろしくお願いします。</p>

<p>さっそくものぐさネタ。</p>

<!-- more -->




<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


<pre><code>  method(__method__).parameters.each do |_, name|
    puts "#{name} =&gt; #{binding.local_variable_get(name)}"
  end
</code></pre>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[ExceptionNotificationがある環境でSlackNotifierだけ使う]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/12/21/slack-notifier-in-exception-notification/"/>
        <updated>2018-12-21T17:53:59+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/12/21/slack-notifier-in-exception-notification</id>
        <content type="html"><![CDATA[<p>ものぐさネタ。</p>

<!-- more -->




<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


<p>バッチ処理での失敗レコード数とかraiseするほどではないんだけど、slackに通知だけしたい時。<br/>
slack-notifierを設定するのがめんどくさいのでexception-notificationに設定されているslackのnotifierを取り出して使う。</p>

<pre><code>ExceptionNotifier.class_variable_get('@@notifiers')[:slack].notifier.ping('hogehoge')
</code></pre>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[たまにCan't verify CSRF token authenticity.]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/12/10/rails-csrf/"/>
        <updated>2018-12-10T13:17:41+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/12/10/rails-csrf</id>
        <content type="html"><![CDATA[<p>時々ログにCan&rsquo;t verify CSRF token authenticity.が表示されます。<br/>
なんでかなーと思っていたら一つ再現パターンを見つけました。</p>

<!-- more -->




<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


<ol>
<li>Aフォームを表示</li>
<li>Bフォームを別タブで表示</li>
<li>Bフォームでsubmit</li>
<li>AフォームでsubmitでCan&rsquo;t verify CSRF token authenticity.発生。</li>
</ol>


<p>AフォームとBフォームで同じcsrf tokenが発行されますが、Bフォームのsubmitでcsrf tokenが使われて値が変わってしまうため<br/>
Aフォームのcsrf tokenが古くなってしまいcsrfエラーが発生します。</p>

<p>ごく稀によくあるやつでした。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[常にjbuilderの値をescape]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/10/11/sanitize-jbuilder/"/>
        <updated>2018-10-11T12:27:37+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/10/11/sanitize-jbuilder</id>
        <content type="html"><![CDATA[<p>jbuliderを使っている時のapiの戻り値、js側でescapeするのかもしれませんが、サーバー側でやりたい時。</p>

<!-- more -->




<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


<pre><code class="ruby"># config/initializers/escape_jbuilder_value
module EscapeJbuilderValue
  def method_missing(*args)
    option = args.extract_options!
    if !::Kernel.block_given? &amp;&amp; !option[:raw]
      if args[1].is_a?(String)
        args[1] = Haml::Util.html_safe(ERB::Util.html_escape(args[1]))
      end
    end
    super(*args)
  end
end

class Jbuilder
  prepend ::EscapeJbuilderValue
end
</code></pre>

<p>HamlつかっているのでHamlと同じescape処理をかけていますが、ここはお好みで(ApplicationController.helpers.sanitizeとかも)。</p>

<pre><code class="ruby">json.body '&lt;span&gt;raw&lt;/hoge&gt;', raw: true
</code></pre>

<p>とかやるとescapeされずに使えます。</p>
]]></content>
    </entry>
    
</feed>
