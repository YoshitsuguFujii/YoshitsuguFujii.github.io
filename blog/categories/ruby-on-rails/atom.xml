<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

    <title><![CDATA[Category: ruby on rails | なんとなく日々徒然と]]></title>
    <link href="http://yoshitsugufujii.github.io/blog/categories/ruby-on-rails/atom.xml" rel="self"/>
    <link href="http://yoshitsugufujii.github.io/"/>
    <updated>2022-11-11T16:26:54+09:00</updated>
    <id>http://yoshitsugufujii.github.io/</id>
    <author>
        <name><![CDATA[Yoshitsugu Fujii]]></name>
        
      </author>
    <generator uri="http://octopress.org/">Octopress</generator>

    
    <entry>
        <title type="html"><![CDATA[Axlsxで半角英数字のみの入力を受け付けたい]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2022/11/11/axlsx-custom-validation/"/>
        <updated>2022-11-11T16:00:07+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2022/11/11/axlsx-custom-validation</id>
        <content type="html"><![CDATA[<p>お仕事いただいていたサービスが立て続けにcloseとなってしまいピンチの藤井です。<br/>
お仕事ください！</p>

<p>暇なので<a href="https://qiita.com/YoshitsuguFujii/items/e35ef63f3c9162babb14">Qiita</a>に記事かいたら全然いいねもらえません。<br/>
いいねください！</p>

<!-- more -->  




<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>Axlsxでセルに入力規則で半角英数字のみで何文字以上、何文字以内を設定したので記載</p>

<pre><code class="ruby">p = Axlsx::Package.new
p.workbook.add_worksheet do |ws|

  ws.add_data_validation("A1:A1", {
    :type =&gt; :custom,
    :formula1 =&gt; 'AND(COUNT(INDEX(FIND(MID(UPPER(A1)&amp;amp;REPT("*",64),ROW($1:$64),1),"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"),))=LEN(A1),LENB(A1)&amp;gt;9,LENB(A1)&amp;lt;65)',
    :showDropDown =&gt; false,
    :showErrorMessage =&gt; true,
    :errorTitle =&gt; '入力エラー',
    :error =&gt; '半角英数字10文字以上、64文字以内で入力してください',
    :errorStyle =&gt; :stop,
    :showInputMessage =&gt; true,
    :prompt =&gt; '半角英数字10文字以上、64文字以内'})

end

p.serialize 'data_validation.xlsx'
</code></pre>

<p><img src="http://yoshitsugufujii.github.io/images/blog/20221111/image.png"></p>

<p>現場からは以上です。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[grapeでrender_to_string]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2021/11/16/render-jbuilder-text-in-grape/"/>
        <updated>2021-11-16T14:08:41+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2021/11/16/render-jbuilder-text-in-grape</id>
        <content type="html"><![CDATA[<p>すっかり存在を忘れていたような、あえて忘れていたような。<br/>
お久しぶりです。藤井です。</p>

<p>最近は横須賀のボートばっかり行ってます。カヤックもはじめました。<br/>
プロフィッシュ45にのっています。<br/>
舘山で３回浮かびました。<br/>
出艇ポイントを知らないのでこれから勉強します。</p>

<p>メモを整理していたら走り書きのようなコードがいくつかあって有意義そうなのをのせようかと</p>

<!-- more -->  




<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>  
     (adsbygoogle = window.adsbygoogle || []).push({});  
</script>


<p></p>

<pre><code class="ruby  ">def render_jbuilder(file_path)  
  root_path =  Rails.root.join 'app', 'views', 'api'  
  engine = ::Tilt.new(root_path / file_path, nil, view_path: root_path)  
  JSON.parse(engine.render(self))  
end  
</code></pre>

<p>root_path取得のところは</p>

<pre><code class="">env['api.tilt.root'] = Rails.root.join 'app', 'views', 'api'  
</code></pre>

<p>の設定をconfig/application.rbとかでやっているのであれば</p>

<pre><code class="">root_path = env['api.tilt.root']  
</code></pre>

<p>でも取れます。</p>

<p>現場からは以上です。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[includeしたmoduleでextendとprepend]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2020/04/10/include-extend-prepend/"/>
        <updated>2020-04-10T16:50:31+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2020/04/10/include-extend-prepend</id>
        <content type="html"><![CDATA[<p>既存の処理を書き換えつつ、さらに機能追加する。
includeとprependとextendを一個のmoduleで実現するサンプル。</p>

<!-- more -->




<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>  
     (adsbygoogle = window.adsbygoogle || []).push({});  
</script>


<p></p>

<pre><code class="ruby"># frozen_string_literal: true

module Hoge
  extend ActiveSupport::Concern

  included do
    singleton_class.send(:prepend, Module.new do
      def override
      end
    end
  end

  module ClassMethods
    def class_method
    end
  end

  def instance_method
  end
end
</code></pre>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[jbuilderのtemplateを使ってhashを取得]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2019/12/19/jbuilder-export-hash/"/>
        <updated>2019-12-19T12:26:18+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2019/12/19/jbuilder-export-hash</id>
        <content type="html"><![CDATA[<p>grape-jbuilderの環境でapi/view/api/users/index.jbuilderを使ってjsonを返しているエンドポイントがある。<br/>
これをcontrollerでhashで取得したい場合。</p>

<p>またapi/view/api/users/index.jbuilderでは@usersを使って値を取り出している。</p>

<p>config/application.rbに以下の設定を想定</p>

<pre><code>class Application &lt; Rails::Application
  config.middleware.use(Rack::Config) do |env|
    env['api.tilt.root'] = Rails.root.join 'app', 'views', 'api'
  end
end
</code></pre>

<!-- more -->




<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>  
     (adsbygoogle = window.adsbygoogle || []).push({});  
</script>


<p></p>

<p>コントローラーでの取り出し例</p>

<pre><code>@users = User.all
engine = ::Tilt.new(request.env['api.tilt.root'] / 'users/index.jbuilder', nil, view_path: request.env['api.tilt.root'])
hash = JSON.parse(engine.render(self))
</code></pre>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[ActiveStorageのDirectUploadでGCSでCORS]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2019/07/12/gcs-cors/"/>
        <updated>2019-07-12T10:55:48+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2019/07/12/gcs-cors</id>
        <content type="html"><![CDATA[<p>GCP上で動かしたらエラーになったのでメモ。</p>

<!-- more -->




<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7039502723411845"
     data-ad-slot="8206045005"></ins></p>

<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


<p>GCSにアップしようとしたら、こんなエラーがでました。</p>

<p>Access to XMLHttpRequest at &lsquo;<a href="https://storage.googleapis.com/">https://storage.googleapis.com/</a><BUCKET NAME>/&lt;ずらずらとcredentialやexpireの情報>&rsquo; from origin &lsquo;<a href="https://hogehoge.com">https://hogehoge.com</a>&rsquo; has been blocked by CORS policy: Response to preflight request doesn&rsquo;t pass access control check: No &lsquo;Access-Control-Allow-Origin&rsquo; header is present on the requested resource.</p>

<p>いくつか設定の仕方があるらしいですがgsutilを使ったやり方でGCSのBucketにCORS対応します。<br/>
(AWSみたいにWEBからは設定できないようです)</p>

<p>まずjsonファイルを作ります。</p>

<pre><code>[
  {
    "origin": ["https://hogehoge.com"],
    "responseHeader": ["Content-Type", "Content-Md5"],
    "method": ["*"],
    "maxAgeSeconds": 3600
  }
]
</code></pre>

<p>originは全部許可する場合はアスタリスクでも可です。<br/>
<code>
[
  {
    "origin": ["*"],
    "responseHeader": ["Content-Type", "Content-Md5"],
    "method": ["*"],
    "maxAgeSeconds": 3600
  }
]
</code></p>

<p>これを設定します。<br/>
<code>
gsutil cors set &lt;上記作成したjson&gt; gs://&lt;bucket name&gt;  
</code></p>

<p>確認<br/>
<code>
gsutil cors get gs://&lt;bucket name&gt;  
</code></p>

<p>で通るようになります。</p>
]]></content>
    </entry>
    
</feed>
