<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

    <title><![CDATA[Category: ruby | なんとなく日々徒然と]]></title>
    <link href="http://yoshitsugufujii.github.io/blog/categories/ruby/atom.xml" rel="self"/>
    <link href="http://yoshitsugufujii.github.io/"/>
    <updated>2018-02-09T19:30:25+09:00</updated>
    <id>http://yoshitsugufujii.github.io/</id>
    <author>
        <name><![CDATA[Yoshitsugu Fujii]]></name>
        
      </author>
    <generator uri="http://octopress.org/">Octopress</generator>

    
    <entry>
        <title type="html"><![CDATA[carrierwaveのリンクの有効期間を個別に設定]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/02/09/carrierwave-expire-setting/"/>
        <updated>2018-02-09T19:27:03+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/02/09/carrierwave-expire-setting</id>
        <content type="html"><![CDATA[<p>全体でかける場合はこうですかね。</p>

<pre><code class="ruby"># config/initializers/carrierwave.rb
CarrierWave::SanitizedFile.sanitize_regexp = /[^[:word:]\.\-\+]/ # for Japanese
CarrierWave.configure do |config|
  # BIZIT_MA for S3
  config.fog_credentials = {
    provider:              'AWS',
    aws_access_key_id:     ENV[:access_key],
    aws_secret_access_key: ENV[:secret],
    region:                ENV['s3_region']
  }

  config.fog_public = false
  config.fog_directory = Settings.aws['s3_bucket']
  config.cache_storage = :fog
  config.fog_authenticated_url_expiration = 1.minutes.to_i
end
</code></pre>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>個々のアップローダークラスでかける場合<br/>
<code>  
class ImageUploader &lt; CarrierWave::Uploader::Base  
  def fog_authenticated_url_expiration  
    1.minutes.to_i  
  end  
end  
</code><br/>
uploader内ではmodelでモデル側のインスタンスを参照できるのでmodel側の条件で動的に有効期限を変えるとかもできそうですね。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[ruby2.5にあげたら例外発生時にstacktraceが吐き出されなくなった]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/01/31/no-backtrace/"/>
        <updated>2018-01-31T11:51:51+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/01/31/no-backtrace</id>
        <content type="html"><![CDATA[<p>Railsである日を境に例外発生時にスタックトレースがでなくなっちゃいました。</p>

<pre><code>F, [2018-01-31T11:41:40.388898 #5662] FATAL -- : 
NoMethodError - undefined method `company_users' for nil:NilClass:
</code></pre>

<p>railsのlogにはこれしかでない。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>検索すると発見。</p>

<p><a href="https://stackoverflow.com/questions/48327987/why-does-ruby-2-5-0-not-show-a-stacktrace-in-rails-5-1-4">Why does Ruby 2.5.0 not show a stacktrace in Rails 5.1.4?</a></p>

<p>なるほどrubyを2.5にあげたからか。</p>

<p>手元の環境を見ると</p>

<pre><code>ruby (2.5)  
rails (5.1.4)  
binding_of_caller (0.7.2)
</code></pre>

<p>0.8.0にbinding_of_callerにあげて解決です。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[国際化対応(お金関連)]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/01/30/money-localization/"/>
        <updated>2018-01-30T10:27:12+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/01/30/money-localization</id>
        <content type="html"><![CDATA[<p>国際化対応。<br/>
DBの日時はutcで保存して表示する時にユーザによって該当のタイムゾーンで表示とか色々な知見はあるかと思いますが。<br/>
お金の区切りもあるんですね。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>お金ってカンマ区切りだけかと思い込んでましたがそうじゃないらしいです。</p>

<p><a href="http://coliss.com/articles/build-websites/operation/writing/53.html">世界各国での数字の区切り方</a></p>

<p>数値がペリオドで送られてくる国やスペースで送ってくる国があるので注意が必要です。<br/>
カンマ一括で消して処理していたらバリデーションで特定の国入力エラーになっていた。</p>

<p>jsのtoLocaleStringとか使うとドイツのブラウザではカンマではなくペリオド入るらしいので気をつけるべし</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[Doorkeeperでパスワードが変更されたらクライアント側でログアウトさせる]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/01/29/logout-when-doorkeeper-password-change/"/>
        <updated>2018-01-29T14:26:19+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/01/29/logout-when-doorkeeper-password-change</id>
        <content type="html"><![CDATA[<p><a href="https://github.com/doorkeeper-gem/doorkeeper">Doorkeeper</a>を使ったoauthの仕組みでプラットフォーム側でパスワード変更の処理を書いててパスワード変更しても現在ログイン状態のユーザーがログアウトされなくて久しぶりにどっぷりハマったのでメモ。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>セッションストアであるredisを見ると同じユーザーで二つのブラウザでログインすると２つ違うsession keyで保持されている。<br/>
このセッションの中身は</p>

<p>一つ目はwarden key(そのままだとユーザID)<br/>
二つ目はencrypted_password</p>

<p>となっているようだ。</p>

<p><a href="https://stackoverflow.com/a/23683925/2223472">https://stackoverflow.com/a/23683925/2223472</a></p>

<p>Doorkeeperを使っているクライアントではoauth認証を使うのでパスワードを使っていない<br/>
そのため二つめencrypted_passwordの値は空になっている。</p>

<p>この二つの値を使って認証しているようだ。</p>

<p>プラットフォーム側でパスワードを変更しても二つ目の値は相変わらず空のためクライアント側ではセッションの状況に変化なしとなり<br/>
そのままログインが保持されてしまう。</p>

<p>tokenを使ったりパスワードを渡す等があったりしたがこうした。</p>

<p>まず、 パスワード変更時刻をプラットフォーム側にcolumnとして追加。<br/>
パスワード変更時にupdateするようにする。</p>

<pre><code class="">class User &lt; ApplicationRecord  
  def reset_password(*args)  
    self.password_changed_at = Time.current  
    super  
  end  
end  
</code></pre>

<p>そしてクライアントサイドでは連携されたpassword_changed_atを使うようにする。</p>

<pre><code class="">class User &lt; ApplicationRecord  
  def authenticatable_salt  
    password_changed_at  
  end  
end  
</code></pre>

<p>これでパスワードが変更されるとクライアントのセッションの中身も変わり、<br/>
他のブラウザでログインしていても適切にログアウトされる。</p>
]]></content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[CircleCIでRuby2.5使おうとしたらbad interpreter]]></title>
        <link href="http://yoshitsugufujii.github.io/blog/2018/01/26/circle-ci-ver-one-ruby-two-five-bad-interpreter/"/>
        <updated>2018-01-26T18:51:07+09:00</updated>
        <id>http://yoshitsugufujii.github.io/blog/2018/01/26/circle-ci-ver-one-ruby-two-five-bad-interpreter</id>
        <content type="html"><![CDATA[<p>一度は成功していたのに急にCircleCI 1.0がこけるようになってしまいました。</p>

<pre><code class="">set ruby version to 2.5.0  
</code></pre>

<p>で</p>

<pre><code class="">ruby-2.5.0 - #generating default wrappers|/-\|/-\|.-\|/-\|/-.|/-\|/-\|.-\|/-\|/-.|/-\|/-\|.-\|/-\|/-.|/-\|/-\|.-\|/-\|.  
Using /home/ubuntu/.rvm/gems/ruby-2.5.0  
/home/ubuntu/.rvm/scripts/override_gem: /home/ubuntu/.rvm/rubies/ruby-2.5.0/bin/gem: /home/travis/.rvm/rubies/ruby-2.5.0/bin/ruby: bad interpreter: No such file or directory  
</code></pre>

<p>のようなエラー。</p>

<!-- more -->


<p></p>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<p>  <br/>
<ins class="adsbygoogle"  
     style="display:block; text-align:center;"  
     data-ad-layout="in-article"  
     data-ad-format="fluid"  
     data-ad-client="ca-pub-7039502723411845"  
     data-ad-slot="8206045005"></ins></p>

<script>    
     (adsbygoogle = window.adsbygoogle || []).push({});    
</script>


<p></p>

<p>調べるとこんなツイートが&hellip;</p>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="en" dir="ltr"><a href="https://twitter.com/circleci?ref_src=twsrc%5Etfw">@circleci</a> I&#39;m getting build failures on ruby 2.5 - it looks like the `gem` command is using a shebang that references a non-existent `/home/travis` directory <a href="https://t.co/UcZREdK2Q8">pic.twitter.com/UcZREdK2Q8</a></p>&mdash; Justin Rhinesmith (@jerhinesmith) <a href="https://twitter.com/jerhinesmith/status/956311677426741248?ref_src=twsrc%5Etfw">2018年1月24日</a></blockquote>


<p></p>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<p></p>

<p>sshするとshebangでエラーになっている同じ現象でした。<br/>
そしてこんなチケットが&hellip;</p>

<p><a href="https://discuss.circleci.com/t/ruby-2-5-0-builds-failing-on-circleci-1-0-due-to-missing-home-travis/19620">Ruby 2.5.0 builds failing on CircleCI 1.0 due to missing <code>/home/travis</code></a></p>

<p>解決しているらしいのですが、普通にエラーでますがな&hellip;<br/>
マニュアルで</p>

<pre><code class="">machine:  
  pre:  
    - sudo ln -s /opt/circleci /home/travis  
</code></pre>

<p>を仕込もうとしたらもうありますエラー。<br/>
そして微妙にパスも違う。</p>

<p>結論。こうしてなおしました。</p>

<pre><code class="">machine:  
  pre:  
    - sudo rm -rf /home/travis  
    - sudo ln -s /home/ubuntu /home/travis  
  ruby:  
    version: 2.5.0  
</code></pre>

<p>すぐなおってくれると思いますが、お困りの人がいたら上記で治ります。</p>
]]></content>
    </entry>
    
</feed>
